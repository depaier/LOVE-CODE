<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í‘¸ì‹œ ì•Œë¦¼ ì„¤ì • | ì‚¬ì£¼ ë§¤ì¹­ ì„œë¹„ìŠ¤</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=BM+Hanna+Pro&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: "BM Hanna Pro", cursive;
      }

      .card {
        border: none;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.95);
      }

      .notification-toggle {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
      }

      .notification-toggle input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 34px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: #2196f3;
      }

      input:checked + .slider:before {
        transform: translateX(26px);
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-enabled {
        background-color: #28a745;
      }

      .status-disabled {
        background-color: #dc3545;
      }

      .status-unknown {
        background-color: #ffc107;
      }

      .settings-section {
        margin-bottom: 30px;
        padding: 20px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.1);
      }

      .btn-request {
        background: linear-gradient(45deg, #667eea, #764ba2);
        border: none;
        border-radius: 10px;
        padding: 12px 30px;
        color: white;
        font-weight: bold;
        transition: transform 0.2s ease;
      }

      .btn-request:hover {
        transform: translateY(-2px);
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card p-4">
            <div class="text-center mb-4">
              <i class="fas fa-bell fa-3x text-primary mb-3"></i>
              <h2>í‘¸ì‹œ ì•Œë¦¼ ì„¤ì •</h2>
              <p class="text-muted">ë§¤ì¹­ ì•Œë¦¼ì„ ë°›ì•„ë³´ì„¸ìš”</p>
            </div>

            <!-- ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìƒíƒœ -->
            <div class="settings-section">
              <h4 class="mb-3">
                <i class="fas fa-globe me-2"></i>
                ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ
              </h4>
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <span
                    id="permission-status"
                    class="status-indicator status-unknown"
                  ></span>
                  <span id="permission-text">ê¶Œí•œ ìƒíƒœ í™•ì¸ ì¤‘...</span>
                </div>
                <button id="request-permission" class="btn btn-request d-none">
                  <i class="fas fa-bell me-2"></i>
                  ê¶Œí•œ ìš”ì²­í•˜ê¸°
                </button>
              </div>
            </div>

            <!-- í‘¸ì‹œ ì•Œë¦¼ êµ¬ë… ìƒíƒœ -->
            <div class="settings-section">
              <h4 class="mb-3">
                <i class="fas fa-toggle-on me-2"></i>
                í‘¸ì‹œ ì•Œë¦¼ êµ¬ë…
              </h4>
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <span
                    id="subscription-status"
                    class="status-indicator status-unknown"
                  ></span>
                  <span id="subscription-text">êµ¬ë… ìƒíƒœ í™•ì¸ ì¤‘...</span>
                </div>
                <label class="notification-toggle">
                  <input type="checkbox" id="notification-toggle" />
                  <span class="slider"></span>
                </label>
              </div>
            </div>

            <!-- ë””ë°”ì´ìŠ¤ ì—°ê²° ìƒíƒœ -->
            <div class="settings-section">
              <h4 class="mb-3">
                <i class="fas fa-mobile-alt me-2"></i>
                ë””ë°”ì´ìŠ¤ ì—°ê²°
              </h4>
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <span
                    id="device-status"
                    class="status-indicator status-unknown"
                  ></span>
                  <span id="device-text">ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘...</span>
                </div>
                <small class="text-muted" id="device-token"></small>
              </div>
            </div>

            <!-- ì•Œë¦¼ í…ŒìŠ¤íŠ¸ -->
            <div class="settings-section">
              <h4 class="mb-3">
                <i class="fas fa-flask me-2"></i>
                ì•Œë¦¼ í…ŒìŠ¤íŠ¸
              </h4>
              <p class="text-muted small mb-3">
                ì„¤ì •ì´ ì œëŒ€ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”
              </p>
              <button id="test-notification" class="btn btn-outline-primary">
                <i class="fas fa-paper-plane me-2"></i>
                í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë³´ë‚´ê¸°
              </button>
            </div>

            <!-- ë„ì›€ë§ -->
            <div class="alert alert-info">
              <h5><i class="fas fa-question-circle me-2"></i>ë„ì›€ë§</h5>
              <ul class="mb-0 small">
                <li>
                  ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œì„ í—ˆìš©í•´ì•¼ í‘¸ì‹œ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤
                </li>
                <li>ë§¤ì¹­ì´ ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤</li>
                <li>ì•Œë¦¼ì„ í´ë¦­í•˜ë©´ ë§¤ì¹­ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤</li>
                <li>
                  <strong>iOS Safari:</strong> iOS 16.4 ì´ìƒì—ì„œ ì§€ì›ë˜ë©°,
                  Safari ì„¤ì • > ê°œì¸ì •ë³´ ë³´í˜¸ ë° ë³´ì•ˆ > ì•Œë¦¼ì—ì„œ ê¶Œí•œì„
                  í—ˆìš©í•´ì£¼ì„¸ìš”
                </li>
                <li>
                  ì„¤ì •ì€ ë¸Œë¼ìš°ì €ë³„ë¡œ ê´€ë¦¬ë˜ë©°, ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œëŠ” ë‹¤ì‹œ ì„¤ì •í•´ì•¼
                  í•©ë‹ˆë‹¤
                </li>
                <li>
                  <strong>íŒ:</strong> í‘¸ì‹œ ì•Œë¦¼ì€ ì•±ì´ ë°±ê·¸ë¼ìš´ë“œì— ìˆì„ ë•Œë„
                  ì‘ë™í•©ë‹ˆë‹¤
                </li>
              </ul>
            </div>

            <div class="text-center mt-4">
              <a href="/" class="btn btn-outline-primary me-2">
                <i class="fas fa-home me-2"></i>
                í™ˆìœ¼ë¡œ
              </a>
              <button id="refresh-status" class="btn btn-outline-secondary">
                <i class="fas fa-sync me-2"></i>
                ìƒíƒœ ìƒˆë¡œê³ ì¹¨
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- í‘¸ì‹œ ì•Œë¦¼ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
      class PushNotificationManager {
        constructor() {
          this.deviceToken = null;
          this.registration = null;
          this.vapidPublicKey = null;
          this.init();
        }

        async init() {
          // Service Worker ë“±ë¡
          if ("serviceWorker" in navigator) {
            try {
              this.registration = await navigator.serviceWorker.register(
                "/static/js/sw.js"
              );
              console.log("Service Worker ë“±ë¡ ì„±ê³µ");
            } catch (error) {
              console.error("Service Worker ë“±ë¡ ì‹¤íŒ¨:", error);
            }
          }

          // VAPID í¼ë¸”ë¦­ í‚¤ ê°€ì ¸ì˜¤ê¸°
          await this.loadVapidPublicKey();

          // ë””ë°”ì´ìŠ¤ í† í° ìƒì„±/ê°€ì ¸ì˜¤ê¸°
          await this.initializeDeviceToken();

          // ìƒíƒœ ì—…ë°ì´íŠ¸
          this.updateStatus();

          // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
          this.setupEventListeners();
        }

        async loadVapidPublicKey() {
          try {
            const response = await fetch("/api/push/vapid-public-key");
            const data = await response.json();
            this.vapidPublicKey = data.publicKey;
          } catch (error) {
            console.error("VAPID í‚¤ ë¡œë“œ ì‹¤íŒ¨:", error);
          }
        }

        async initializeDeviceToken() {
          try {
            const response = await fetch("/api/user/device-token", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            });
            const data = await response.json();
            this.deviceToken = data.device_token;
            document.getElementById("device-token").textContent =
              this.deviceToken.substring(0, 8) + "...";
          } catch (error) {
            console.error("ë””ë°”ì´ìŠ¤ í† í° ìƒì„± ì‹¤íŒ¨:", error);
          }
        }

        async updateStatus() {
          // ë¸Œë¼ìš°ì € ê¶Œí•œ ìƒíƒœ í™•ì¸
          this.updatePermissionStatus();

          // í‘¸ì‹œ êµ¬ë… ìƒíƒœ í™•ì¸
          await this.updateSubscriptionStatus();

          // ë””ë°”ì´ìŠ¤ ì—°ê²° ìƒíƒœ í™•ì¸
          this.updateDeviceStatus();
        }

        updatePermissionStatus() {
          const permission = Notification.permission;
          const statusEl = document.getElementById("permission-status");
          const textEl = document.getElementById("permission-text");
          const requestBtn = document.getElementById("request-permission");

          statusEl.className = "status-indicator";

          switch (permission) {
            case "granted":
              statusEl.classList.add("status-enabled");
              textEl.textContent = "í—ˆìš©ë¨";
              requestBtn.classList.add("d-none");
              break;
            case "denied":
              statusEl.classList.add("status-disabled");
              textEl.textContent = "ì°¨ë‹¨ë¨";
              requestBtn.classList.add("d-none");
              break;
            default:
              statusEl.classList.add("status-unknown");
              textEl.textContent = "ìš”ì²­ í•„ìš”";
              requestBtn.classList.remove("d-none");
          }
        }

        async updateSubscriptionStatus() {
          const statusEl = document.getElementById("subscription-status");
          const textEl = document.getElementById("subscription-text");
          const toggleEl = document.getElementById("notification-toggle");

          statusEl.className = "status-indicator";

          if (!this.registration) {
            statusEl.classList.add("status-disabled");
            textEl.textContent = "Service Worker ë¯¸ì§€ì›";
            toggleEl.disabled = true;
            return;
          }

          try {
            const subscription =
              await this.registration.pushManager.getSubscription();

            if (subscription) {
              statusEl.classList.add("status-enabled");
              textEl.textContent = "êµ¬ë… ì¤‘";
              toggleEl.checked = true;
            } else {
              statusEl.classList.add("status-disabled");
              textEl.textContent = "ë¯¸êµ¬ë…";
              toggleEl.checked = false;
            }
          } catch (error) {
            statusEl.classList.add("status-unknown");
            textEl.textContent = "í™•ì¸ ì‹¤íŒ¨";
            console.error("êµ¬ë… ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:", error);
          }
        }

        updateDeviceStatus() {
          const statusEl = document.getElementById("device-status");
          const textEl = document.getElementById("device-text");

          statusEl.className = "status-indicator";

          if (this.deviceToken) {
            statusEl.classList.add("status-enabled");
            textEl.textContent = "ì—°ê²°ë¨";
          } else {
            statusEl.classList.add("status-disabled");
            textEl.textContent = "ë¯¸ì—°ê²°";
          }
        }

        setupEventListeners() {
          // ê¶Œí•œ ìš”ì²­ ë²„íŠ¼
          document
            .getElementById("request-permission")
            .addEventListener("click", async () => {
              try {
                const permission = await Notification.requestPermission();
                this.updatePermissionStatus();

                if (permission === "granted") {
                  showToast("ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
                } else {
                  showToast("ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.", "warning");
                }
              } catch (error) {
                console.error("ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:", error);
                showToast("ê¶Œí•œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
              }
            });

          // ì•Œë¦¼ í† ê¸€
          document
            .getElementById("notification-toggle")
            .addEventListener("change", async (e) => {
              if (e.target.checked) {
                await this.subscribePush();
              } else {
                await this.unsubscribePush();
              }
            });

          // ìƒíƒœ ìƒˆë¡œê³ ì¹¨
          document
            .getElementById("refresh-status")
            .addEventListener("click", () => {
              this.updateStatus();
              showToast("ìƒíƒœë¥¼ ìƒˆë¡œê³ ì¹¨í–ˆìŠµë‹ˆë‹¤.", "info");
            });

          // í…ŒìŠ¤íŠ¸ ì•Œë¦¼
          document
            .getElementById("test-notification")
            .addEventListener("click", async () => {
              await this.sendTestNotification();
            });
        }

        async subscribePush() {
          try {
            if (!this.registration || !this.vapidPublicKey) {
              showToast("í‘¸ì‹œ ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” í™˜ê²½ì…ë‹ˆë‹¤.", "warning");
              return;
            }

            const subscription = await this.registration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: this.urlBase64ToUint8Array(
                this.vapidPublicKey
              ),
            });

            // ì„œë²„ì— êµ¬ë… ì •ë³´ ì „ì†¡
            const response = await fetch("/api/push/subscribe", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                device_token: this.deviceToken,
                subscription: {
                  endpoint: subscription.endpoint,
                  keys: {
                    p256dh: this.arrayBufferToBase64(
                      subscription.getKey("p256dh")
                    ),
                    auth: this.arrayBufferToBase64(subscription.getKey("auth")),
                  },
                },
              }),
            });

            if (response.ok) {
              showToast("í‘¸ì‹œ ì•Œë¦¼ êµ¬ë…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
              this.updateSubscriptionStatus();
            } else {
              throw new Error("ì„œë²„ ë“±ë¡ ì‹¤íŒ¨");
            }
          } catch (error) {
            console.error("í‘¸ì‹œ êµ¬ë… ì‹¤íŒ¨:", error);
            showToast("í‘¸ì‹œ ì•Œë¦¼ êµ¬ë…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
            document.getElementById("notification-toggle").checked = false;
          }
        }

        async unsubscribePush() {
          try {
            const subscription =
              await this.registration.pushManager.getSubscription();
            if (subscription) {
              await subscription.unsubscribe();

              // ì„œë²„ì— êµ¬ë… í•´ì œ ìš”ì²­
              await fetch("/api/push/unsubscribe", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  device_token: this.deviceToken,
                }),
              });
            }

            showToast("í‘¸ì‹œ ì•Œë¦¼ êµ¬ë…ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "info");
            this.updateSubscriptionStatus();
          } catch (error) {
            console.error("í‘¸ì‹œ êµ¬ë… í•´ì œ ì‹¤íŒ¨:", error);
            showToast("í‘¸ì‹œ ì•Œë¦¼ êµ¬ë… í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
          }
        }

        async sendTestNotification() {
          try {
            const response = await fetch("/api/push/test", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                device_token: this.deviceToken,
                title: "í…ŒìŠ¤íŠ¸ ì•Œë¦¼",
                body: "í‘¸ì‹œ ì•Œë¦¼ ì„¤ì •ì´ ì œëŒ€ë¡œ ì‘ë™í•˜ê³  ìˆì–´ìš”! ğŸ‰",
              }),
            });

            if (response.ok) {
              showToast("í…ŒìŠ¤íŠ¸ ì•Œë¦¼ì„ ì „ì†¡í–ˆìŠµë‹ˆë‹¤!", "success");
            } else {
              throw new Error("í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨");
            }
          } catch (error) {
            console.error("í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì‹¤íŒ¨:", error);
            showToast("í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
          }
        }

        urlBase64ToUint8Array(base64String) {
          const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
          const base64 = (base64String + padding)
            .replace(/-/g, "+")
            .replace(/_/g, "/");

          const rawData = window.atob(base64);
          const outputArray = new Uint8Array(rawData.length);

          for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
          }
          return outputArray;
        }

        arrayBufferToBase64(buffer) {
          const bytes = new Uint8Array(buffer);
          let binary = "";
          for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
          }
          return window.btoa(binary);
        }
      }

      // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
      function showToast(message, type = "info") {
        const toastHtml = `
                <div class="toast align-items-center text-white bg-${type} border-0 position-fixed"
                     style="top: 20px; right: 20px; z-index: 9999;"
                     role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-${
                              type === "success"
                                ? "check"
                                : type === "error"
                                ? "exclamation"
                                : "info"
                            }-circle me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto"
                                data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

        document.body.insertAdjacentHTML("beforeend", toastHtml);

        const toastElement = document.querySelector(".toast:last-child");
        const toast = new bootstrap.Toast(toastElement, {
          autohide: true,
          delay: 3000,
        });
        toast.show();

        // ìë™ ì œê±°
        toastElement.addEventListener("hidden.bs.toast", () => {
          toastElement.remove();
        });
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener("DOMContentLoaded", () => {
        new PushNotificationManager();
      });
    </script>
  </body>
</html>
