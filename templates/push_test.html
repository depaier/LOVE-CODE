<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>🔔 푸시 알림 테스트 | LOVE-CODE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=BM+Hanna+Pro&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "BM Hanna Pro", cursive;
        background: linear-gradient(
          135deg,
          #fef9e7 0%,
          #f6f3f0 50%,
          #f0ebdc 100%
        );
        background-attachment: fixed;
        color: #3a3a3a;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        background: linear-gradient(135deg, #ffffff 0%, #fefcf8 100%);
        border: 2px solid rgba(138, 109, 89, 0.3);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1),
          0 5px 15px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.8);
        padding: 40px;
        text-align: center;
      }

      h1 {
        font-size: 2.5em;
        background: linear-gradient(
          135deg,
          #5a3a22 0%,
          #8b4513 50%,
          #5a3a22 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 30px;
      }

      .status-section {
        margin: 30px 0;
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        border: 1px solid rgba(189, 160, 140, 0.3);
      }

      .status-item {
        margin: 10px 0;
        font-size: 1.1em;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .status-value {
        font-weight: bold;
        padding: 5px 10px;
        border-radius: 10px;
        background: rgba(168, 68, 72, 0.1);
        color: #a84448;
      }

      .btn {
        background: linear-gradient(
          135deg,
          #a84448 0%,
          #c54d52 50%,
          #a84448 100%
        );
        color: #ffffff;
        border: none;
        border-radius: 25px;
        padding: 15px 30px;
        font-size: 1.3em;
        font-family: "BM Hanna Pro", cursive;
        cursor: pointer;
        margin: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(168, 68, 72, 0.3),
          0 3px 10px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(168, 68, 72, 0.4),
          0 5px 15px rgba(0, 0, 0, 0.15);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
      }

      .log-section {
        margin-top: 30px;
        text-align: left;
      }

      .log-box {
        background: #2d3748;
        color: #e2e8f0;
        padding: 20px;
        border-radius: 10px;
        font-family: "Courier New", monospace;
        font-size: 0.9em;
        line-height: 1.5;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        border: 1px solid rgba(138, 109, 89, 0.3);
      }

      .success {
        color: #48bb78;
      }
      .error {
        color: #f56565;
      }
      .info {
        color: #4299e1;
      }
      .warning {
        color: #ed8936;
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px;
          margin: 10px;
        }

        h1 {
          font-size: 2em;
        }

        .btn {
          width: 100%;
          margin: 10px 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🔔 푸시 알림 테스트</h1>

      <div class="status-section">
        <h3>📊 현재 상태</h3>
        <div class="status-item">
          <span>브라우저 지원:</span>
          <span class="status-value" id="browser-support">확인 중...</span>
        </div>
        <div class="status-item">
          <span>알림 권한:</span>
          <span class="status-value" id="permission-status">확인 중...</span>
        </div>
        <div class="status-item">
          <span>Service Worker:</span>
          <span class="status-value" id="sw-status">확인 중...</span>
        </div>
        <div class="status-item">
          <span>구독 상태:</span>
          <span class="status-value" id="subscription-status">확인 중...</span>
        </div>
        <div class="status-item">
          <span>디바이스 토큰:</span>
          <span class="status-value" id="device-token">없음</span>
        </div>
      </div>

       <div>
         <button class="btn" id="request-permission">🔔 알림 권한 요청</button>
         <button class="btn" id="subscribe-push">📝 푸시 구독</button>
         <button class="btn" id="send-test">🚀 테스트 알림 전송</button>
         <button class="btn" id="debug-env" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);">🔍 환경변수 확인</button>
       </div>

      <div class="log-section">
        <h3>📝 로그</h3>
        <div class="log-box" id="log-box">
          <span class="info">[INFO] 페이지가 로드되었습니다.</span>
        </div>
      </div>
    </div>

    <script>
      const log = document.getElementById("log-box");
      const VAPID_PUBLIC_KEY =
        "BHfpLCcwKDVg2TkshpmVn9Tr3nizK-dxkCAkAIIkp59UBXRU3Iwim8FuSCXoQOLUYjPxO6GJPncPup_bBpK7z-w";

      let registration = null;
      let subscription = null;
      let deviceToken = localStorage.getItem("deviceToken");

      function addLog(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const className = type;
        log.innerHTML += `\n<span class="${className}">[${type.toUpperCase()}] ${timestamp}: ${message}</span>`;
        log.scrollTop = log.scrollHeight;
        console.log(`[${type.toUpperCase()}] ${message}`);
      }

      function updateStatus() {
        // 브라우저 지원 확인
        const browserSupport =
          "serviceWorker" in navigator && "PushManager" in window;
        document.getElementById("browser-support").textContent = browserSupport
          ? "✅ 지원"
          : "❌ 미지원";

        // 알림 권한 확인
        const permission = Notification.permission;
        document.getElementById("permission-status").textContent =
          permission === "granted"
            ? "✅ 허용됨"
            : permission === "denied"
            ? "❌ 차단됨"
            : "⏳ 대기 중";

        // Service Worker 상태
        document.getElementById("sw-status").textContent = registration
          ? "✅ 등록됨"
          : "❌ 미등록";

        // 구독 상태
        document.getElementById("subscription-status").textContent =
          subscription ? "✅ 구독 중" : "❌ 미구독";

        // 디바이스 토큰
        document.getElementById("device-token").textContent = deviceToken
          ? deviceToken.substring(0, 12) + "..."
          : "없음";
      }

      function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding)
          .replace(/-/g, "+")
          .replace(/_/g, "/");
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      async function initializeServiceWorker() {
        try {
          if (!("serviceWorker" in navigator)) {
            throw new Error("Service Worker를 지원하지 않는 브라우저입니다.");
          }

          registration = await navigator.serviceWorker.register(
            "/static/js/sw.js"
          );
          addLog("Service Worker 등록 완료", "success");

          // 기존 구독 확인
          subscription = await registration.pushManager.getSubscription();
          if (subscription) {
            addLog("기존 푸시 구독을 찾았습니다.", "info");
          }

          updateStatus();
        } catch (error) {
          addLog(`Service Worker 초기화 실패: ${error.message}`, "error");
        }
      }

      async function createDeviceToken() {
        try {
          const response = await fetch("/api/user/device-token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          });
          const data = await response.json();
          deviceToken = data.device_token;
          localStorage.setItem("deviceToken", deviceToken);
          addLog(`디바이스 토큰 생성: ${deviceToken}`, "success");
          updateStatus();
        } catch (error) {
          addLog(`디바이스 토큰 생성 실패: ${error.message}`, "error");
        }
      }

      // 이벤트 리스너
      document
        .getElementById("request-permission")
        .addEventListener("click", async () => {
          try {
            const permission = await Notification.requestPermission();
            addLog(
              `알림 권한 요청 결과: ${permission}`,
              permission === "granted" ? "success" : "warning"
            );
            updateStatus();
          } catch (error) {
            addLog(`권한 요청 실패: ${error.message}`, "error");
          }
        });

      document
        .getElementById("subscribe-push")
        .addEventListener("click", async () => {
          try {
            if (!registration) {
              throw new Error("Service Worker가 등록되지 않았습니다.");
            }

            if (!deviceToken) {
              await createDeviceToken();
            }

            subscription = await registration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
            });

            addLog("푸시 구독 성공!", "success");

            // 서버에 구독 정보 전송
            const response = await fetch("/api/push/subscribe", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                device_token: deviceToken,
                subscription: {
                  endpoint: subscription.endpoint,
                  keys: {
                    p256dh: btoa(
                      String.fromCharCode.apply(
                        null,
                        new Uint8Array(subscription.getKey("p256dh"))
                      )
                    ),
                    auth: btoa(
                      String.fromCharCode.apply(
                        null,
                        new Uint8Array(subscription.getKey("auth"))
                      )
                    ),
                  },
                },
              }),
            });

            if (response.ok) {
              addLog("서버에 구독 정보 저장 완료", "success");
            } else {
              addLog("서버 구독 저장 실패", "error");
            }

            updateStatus();
          } catch (error) {
            addLog(`푸시 구독 실패: ${error.message}`, "error");
          }
        });

      document
        .getElementById("send-test")
        .addEventListener("click", async () => {
          try {
            if (!deviceToken) {
              throw new Error(
                "디바이스 토큰이 없습니다. 먼저 푸시 구독을 해주세요."
              );
            }

            const button = document.getElementById("send-test");
            button.disabled = true;
            button.textContent = "⏳ 전송 중...";

            const response = await fetch("/api/push/test", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                device_token: deviceToken,
              }),
            });

            const result = await response.json();

            if (response.ok) {
              addLog("🚀 테스트 알림 전송 성공!", "success");
              addLog(`서버 응답: ${result.message}`, "info");
            } else {
              addLog(`테스트 알림 전송 실패: ${result.error}`, "error");
            }
          } catch (error) {
            addLog(`테스트 전송 중 오류: ${error.message}`, "error");
          } finally {
            const button = document.getElementById("send-test");
            button.disabled = false;
            button.textContent = "🚀 테스트 알림 전송";
           }
         });

       document
         .getElementById("debug-env")
         .addEventListener("click", async () => {
           try {
             addLog("🔍 서버 환경변수 확인 중...", "info");
             
             const response = await fetch("/api/debug/env");
             const result = await response.json();
             
             if (response.ok) {
               addLog("📊 서버 환경변수 상태:", "success");
               addLog(`• VAPID Email: ${result.vapid_email}`, "info");
               addLog(`• VAPID Public Key: ${result.vapid_public_key}`, "info");
               addLog(`• VAPID Private Key: ${result.vapid_private_key}`, "info");
               addLog(`• Supabase URL: ${result.supabase_url}`, "info");
               addLog(`• pywebpush 라이브러리: ${result.pywebpush_available ? '✅ 사용 가능' : '❌ 사용 불가'}`, "info");
             } else {
               addLog(`환경변수 확인 실패: ${result.error}`, "error");
             }
           } catch (error) {
             addLog(`환경변수 확인 중 오류: ${error.message}`, "error");
           }
         });

       // 페이지 로드 시 초기화
      document.addEventListener("DOMContentLoaded", async () => {
        addLog("푸시 알림 테스트 페이지 초기화 시작", "info");
        updateStatus();
        await initializeServiceWorker();

        if (!deviceToken) {
          await createDeviceToken();
        }
      });
    </script>
  </body>
</html>
