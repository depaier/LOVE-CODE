<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ”” í‘¸ì‹œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ | LOVE-CODE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=BM+Hanna+Pro&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "BM Hanna Pro", cursive;
        background: linear-gradient(
          135deg,
          #fef9e7 0%,
          #f6f3f0 50%,
          #f0ebdc 100%
        );
        background-attachment: fixed;
        color: #3a3a3a;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        background: linear-gradient(135deg, #ffffff 0%, #fefcf8 100%);
        border: 2px solid rgba(138, 109, 89, 0.3);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1),
          0 5px 15px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.8);
        padding: 40px;
        text-align: center;
      }

      h1 {
        font-size: 2.5em;
        background: linear-gradient(
          135deg,
          #5a3a22 0%,
          #8b4513 50%,
          #5a3a22 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 30px;
      }

      .status-section {
        margin: 30px 0;
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        border: 1px solid rgba(189, 160, 140, 0.3);
      }

      .status-item {
        margin: 10px 0;
        font-size: 1.1em;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .status-value {
        font-weight: bold;
        padding: 5px 10px;
        border-radius: 10px;
        background: rgba(168, 68, 72, 0.1);
        color: #a84448;
      }

      .btn {
        background: linear-gradient(
          135deg,
          #a84448 0%,
          #c54d52 50%,
          #a84448 100%
        );
        color: #ffffff;
        border: none;
        border-radius: 25px;
        padding: 15px 30px;
        font-size: 1.3em;
        font-family: "BM Hanna Pro", cursive;
        cursor: pointer;
        margin: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(168, 68, 72, 0.3),
          0 3px 10px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(168, 68, 72, 0.4),
          0 5px 15px rgba(0, 0, 0, 0.15);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
      }

      .log-section {
        margin-top: 30px;
        text-align: left;
      }

      .log-box {
        background: #2d3748;
        color: #e2e8f0;
        padding: 20px;
        border-radius: 10px;
        font-family: "Courier New", monospace;
        font-size: 0.9em;
        line-height: 1.5;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        border: 1px solid rgba(138, 109, 89, 0.3);
      }

      .success {
        color: #48bb78;
      }
      .error {
        color: #f56565;
      }
      .info {
        color: #4299e1;
      }
      .warning {
        color: #ed8936;
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px;
          margin: 10px;
        }

        h1 {
          font-size: 2em;
        }

        .btn {
          width: 100%;
          margin: 10px 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”” í‘¸ì‹œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸</h1>

      <div class="status-section">
        <h3>ğŸ“Š í˜„ì¬ ìƒíƒœ</h3>
        <div class="status-item">
          <span>ë¸Œë¼ìš°ì € ì§€ì›:</span>
          <span class="status-value" id="browser-support">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="status-item">
          <span>ì•Œë¦¼ ê¶Œí•œ:</span>
          <span class="status-value" id="permission-status">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="status-item">
          <span>Service Worker:</span>
          <span class="status-value" id="sw-status">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="status-item">
          <span>êµ¬ë… ìƒíƒœ:</span>
          <span class="status-value" id="subscription-status">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="status-item">
          <span>ë””ë°”ì´ìŠ¤ í† í°:</span>
          <span class="status-value" id="device-token">ì—†ìŒ</span>
        </div>
      </div>

       <div>
         <button class="btn" id="request-permission">ğŸ”” ì•Œë¦¼ ê¶Œí•œ ìš”ì²­</button>
         <button class="btn" id="subscribe-push">ğŸ“ í‘¸ì‹œ êµ¬ë…</button>
         <button class="btn" id="send-test">ğŸš€ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡</button>
         <button class="btn" id="debug-env" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);">ğŸ” í™˜ê²½ë³€ìˆ˜ í™•ì¸</button>
       </div>

      <div class="log-section">
        <h3>ğŸ“ ë¡œê·¸</h3>
        <div class="log-box" id="log-box">
          <span class="info">[INFO] í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.</span>
        </div>
      </div>
    </div>

    <script>
      const log = document.getElementById("log-box");
      const VAPID_PUBLIC_KEY =
        "BHfpLCcwKDVg2TkshpmVn9Tr3nizK-dxkCAkAIIkp59UBXRU3Iwim8FuSCXoQOLUYjPxO6GJPncPup_bBpK7z-w";

      let registration = null;
      let subscription = null;
      let deviceToken = localStorage.getItem("deviceToken");

      function addLog(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const className = type;
        log.innerHTML += `\n<span class="${className}">[${type.toUpperCase()}] ${timestamp}: ${message}</span>`;
        log.scrollTop = log.scrollHeight;
        console.log(`[${type.toUpperCase()}] ${message}`);
      }

      function updateStatus() {
        // ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸
        const browserSupport =
          "serviceWorker" in navigator && "PushManager" in window;
        document.getElementById("browser-support").textContent = browserSupport
          ? "âœ… ì§€ì›"
          : "âŒ ë¯¸ì§€ì›";

        // ì•Œë¦¼ ê¶Œí•œ í™•ì¸
        const permission = Notification.permission;
        document.getElementById("permission-status").textContent =
          permission === "granted"
            ? "âœ… í—ˆìš©ë¨"
            : permission === "denied"
            ? "âŒ ì°¨ë‹¨ë¨"
            : "â³ ëŒ€ê¸° ì¤‘";

        // Service Worker ìƒíƒœ
        document.getElementById("sw-status").textContent = registration
          ? "âœ… ë“±ë¡ë¨"
          : "âŒ ë¯¸ë“±ë¡";

        // êµ¬ë… ìƒíƒœ
        document.getElementById("subscription-status").textContent =
          subscription ? "âœ… êµ¬ë… ì¤‘" : "âŒ ë¯¸êµ¬ë…";

        // ë””ë°”ì´ìŠ¤ í† í°
        document.getElementById("device-token").textContent = deviceToken
          ? deviceToken.substring(0, 12) + "..."
          : "ì—†ìŒ";
      }

      function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding)
          .replace(/-/g, "+")
          .replace(/_/g, "/");
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      async function initializeServiceWorker() {
        try {
          if (!("serviceWorker" in navigator)) {
            throw new Error("Service Workerë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
          }

          registration = await navigator.serviceWorker.register(
            "/static/js/sw.js"
          );
          addLog("Service Worker ë“±ë¡ ì™„ë£Œ", "success");

          // ê¸°ì¡´ êµ¬ë… í™•ì¸
          subscription = await registration.pushManager.getSubscription();
          if (subscription) {
            addLog("ê¸°ì¡´ í‘¸ì‹œ êµ¬ë…ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.", "info");
          }

          updateStatus();
        } catch (error) {
          addLog(`Service Worker ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, "error");
        }
      }

      async function createDeviceToken() {
        try {
          const response = await fetch("/api/user/device-token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          });
          const data = await response.json();
          deviceToken = data.device_token;
          localStorage.setItem("deviceToken", deviceToken);
          addLog(`ë””ë°”ì´ìŠ¤ í† í° ìƒì„±: ${deviceToken}`, "success");
          updateStatus();
        } catch (error) {
          addLog(`ë””ë°”ì´ìŠ¤ í† í° ìƒì„± ì‹¤íŒ¨: ${error.message}`, "error");
        }
      }

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document
        .getElementById("request-permission")
        .addEventListener("click", async () => {
          try {
            const permission = await Notification.requestPermission();
            addLog(
              `ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ê²°ê³¼: ${permission}`,
              permission === "granted" ? "success" : "warning"
            );
            updateStatus();
          } catch (error) {
            addLog(`ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨: ${error.message}`, "error");
          }
        });

      document
        .getElementById("subscribe-push")
        .addEventListener("click", async () => {
          try {
            if (!registration) {
              throw new Error("Service Workerê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }

            if (!deviceToken) {
              await createDeviceToken();
            }

            subscription = await registration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
            });

            addLog("í‘¸ì‹œ êµ¬ë… ì„±ê³µ!", "success");

            // ì„œë²„ì— êµ¬ë… ì •ë³´ ì „ì†¡
            const response = await fetch("/api/push/subscribe", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                device_token: deviceToken,
                subscription: {
                  endpoint: subscription.endpoint,
                  keys: {
                    p256dh: btoa(
                      String.fromCharCode.apply(
                        null,
                        new Uint8Array(subscription.getKey("p256dh"))
                      )
                    ),
                    auth: btoa(
                      String.fromCharCode.apply(
                        null,
                        new Uint8Array(subscription.getKey("auth"))
                      )
                    ),
                  },
                },
              }),
            });

            if (response.ok) {
              addLog("ì„œë²„ì— êµ¬ë… ì •ë³´ ì €ì¥ ì™„ë£Œ", "success");
            } else {
              addLog("ì„œë²„ êµ¬ë… ì €ì¥ ì‹¤íŒ¨", "error");
            }

            updateStatus();
          } catch (error) {
            addLog(`í‘¸ì‹œ êµ¬ë… ì‹¤íŒ¨: ${error.message}`, "error");
          }
        });

      document
        .getElementById("send-test")
        .addEventListener("click", async () => {
          try {
            if (!deviceToken) {
              throw new Error(
                "ë””ë°”ì´ìŠ¤ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í‘¸ì‹œ êµ¬ë…ì„ í•´ì£¼ì„¸ìš”."
              );
            }

            const button = document.getElementById("send-test");
            button.disabled = true;
            button.textContent = "â³ ì „ì†¡ ì¤‘...";

            const response = await fetch("/api/push/test", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                device_token: deviceToken,
              }),
            });

            const result = await response.json();

            if (response.ok) {
              addLog("ğŸš€ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì„±ê³µ!", "success");
              addLog(`ì„œë²„ ì‘ë‹µ: ${result.message}`, "info");
            } else {
              addLog(`í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ${result.error}`, "error");
            }
          } catch (error) {
            addLog(`í…ŒìŠ¤íŠ¸ ì „ì†¡ ì¤‘ ì˜¤ë¥˜: ${error.message}`, "error");
          } finally {
            const button = document.getElementById("send-test");
            button.disabled = false;
            button.textContent = "ğŸš€ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡";
           }
         });

       document
         .getElementById("debug-env")
         .addEventListener("click", async () => {
           try {
             addLog("ğŸ” ì„œë²„ í™˜ê²½ë³€ìˆ˜ í™•ì¸ ì¤‘...", "info");
             
             const response = await fetch("/api/debug/env");
             const result = await response.json();
             
             if (response.ok) {
               addLog("ğŸ“Š ì„œë²„ í™˜ê²½ë³€ìˆ˜ ìƒíƒœ:", "success");
               addLog(`â€¢ VAPID Email: ${result.vapid_email}`, "info");
               addLog(`â€¢ VAPID Public Key: ${result.vapid_public_key}`, "info");
               addLog(`â€¢ VAPID Private Key: ${result.vapid_private_key}`, "info");
               addLog(`â€¢ Supabase URL: ${result.supabase_url}`, "info");
               addLog(`â€¢ pywebpush ë¼ì´ë¸ŒëŸ¬ë¦¬: ${result.pywebpush_available ? 'âœ… ì‚¬ìš© ê°€ëŠ¥' : 'âŒ ì‚¬ìš© ë¶ˆê°€'}`, "info");
             } else {
               addLog(`í™˜ê²½ë³€ìˆ˜ í™•ì¸ ì‹¤íŒ¨: ${result.error}`, "error");
             }
           } catch (error) {
             addLog(`í™˜ê²½ë³€ìˆ˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜: ${error.message}`, "error");
           }
         });

       // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener("DOMContentLoaded", async () => {
        addLog("í‘¸ì‹œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘", "info");
        updateStatus();
        await initializeServiceWorker();

        if (!deviceToken) {
          await createDeviceToken();
        }
      });
    </script>
  </body>
</html>
