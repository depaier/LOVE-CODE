<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>관리자 페이지 - LOVE-CODE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=BM+Hanna+Pro&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "BM Hanna Pro", cursive;
        background-color: #fdfaf3;
        margin: 0;
        padding: 20px;
        color: #3a3a3a;
      }

      .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: #ffffff;
        padding: 30px;
        border: 3px solid #8a6d59;
        border-radius: 8px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      h1 {
        font-size: 2.5em;
        color: #5a3a22;
        text-align: center;
        margin-bottom: 30px;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background-color: #f8f5f0;
        padding: 20px;
        border-radius: 6px;
        border: 2px solid #bda08c;
        text-align: center;
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #a84448;
        transition: transform 0.3s ease, color 0.3s ease;
      }

      .stat-label {
        font-size: 1.2em;
        color: #5a3a22;
      }

      .search-bar {
        margin-bottom: 20px;
        text-align: center;
      }

      .search-bar input {
        padding: 10px;
        border: 2px solid #bda08c;
        border-radius: 4px;
        font-size: 1em;
        width: 300px;
        font-family: "BM Hanna Pro", cursive;
      }

      .results-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .results-table th,
      .results-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
      }

      .results-table th {
        background-color: #f8f5f0;
        color: #5a3a22;
        font-size: 1.1em;
      }

      .results-table tr:hover {
        background-color: #f9f6f2;
      }

      .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        font-family: "BM Hanna Pro", cursive;
        margin-right: 5px;
      }

      .view-btn {
        background-color: #a84448;
        color: white;
      }

      .delete-btn {
        background-color: #666;
        color: white;
      }

      .back-btn {
        display: inline-block;
        padding: 10px 20px;
        background-color: #8a6d59;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        margin-bottom: 20px;
        font-family: "BM Hanna Pro", cursive;
      }

      .back-btn:hover {
        background-color: #6d4a3d;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: #ffffff;
        margin: 5% auto;
        padding: 20px;
        border: 3px solid #8a6d59;
        border-radius: 8px;
        width: 90%;
        max-width: 700px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 2em;
        cursor: pointer;
        color: #5a3a22;
      }

      .result-detail h3 {
        color: #5a3a22;
        margin-bottom: 10px;
      }

      .result-detail p {
        margin-bottom: 15px;
        line-height: 1.6;
      }

      .no-results {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 1.2em;
      }

      /* 로딩 스피너 애니메이션 */
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .admin-container {
          padding: 15px;
          margin: 10px;
        }

        .stats {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .results-table {
          font-size: 0.9em;
        }

        .results-table th,
        .results-table td {
          padding: 8px;
        }

        .search-bar input {
          width: 100%;
          max-width: 300px;
        }

        .action-btn {
          padding: 4px 8px;
          font-size: 0.8em;
          margin-right: 3px;
        }
      }

      @media (max-width: 480px) {
        .admin-container {
          padding: 10px;
          margin: 5px;
          border-radius: 4px;
        }

        h1 {
          font-size: 2em;
        }

        .results-table {
          font-size: 0.8em;
        }

        .results-table th:nth-child(4),
        .results-table td:nth-child(4),
        .results-table th:nth-child(5),
        .results-table td:nth-child(5),
        .results-table th:nth-child(6),
        .results-table td:nth-child(6) {
          display: none; /* 인스타그램, 매칭상태, 분석일시 열 숨기기 */
        }

        .back-btn {
          font-size: 0.9em;
          padding: 8px 16px;
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <h1>📊 관리자 페이지</h1>

      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
        "
      >
        <a href="/" class="back-btn">← 메인 페이지로 돌아가기</a>
        <a href="/admin/logout" class="back-btn" style="background-color: #666"
          >로그아웃</a
        >
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="total-count">{{ results|length }}</div>
          <div class="stat-label">총 분석 수</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="today-count">0</div>
          <div class="stat-label">오늘 분석 수</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="unique-users">{{ results|length }}</div>
          <div class="stat-label">등록된 사용자</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="matches-count">0</div>
          <div class="stat-label">매칭 결과 수</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" style="color: #ff6b6b">
            {{ unmatched_stats.unmatched_female if unmatched_stats else 0 }}
          </div>
          <div class="stat-label">미매칭 여자</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" style="color: #4ecdc4">
            {{ unmatched_stats.unmatched_male if unmatched_stats else 0 }}
          </div>
          <div class="stat-label">미매칭 남자</div>
        </div>
      </div>

      <!-- 매칭 기능 섹션 -->
      <div style="margin: 30px 0; text-align: center">
        <button
          id="api-test-btn"
          style="
            background-color: #666;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            font-size: 1.2em;
            font-family: 'BM Hanna Pro', cursive;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(102, 102, 102, 0.3);
            margin-bottom: 15px;
          "
          onmouseover="this.style.backgroundColor='#555'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(102, 102, 102, 0.4)';"
          onmouseout="this.style.backgroundColor='#666'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(102, 102, 102, 0.3)';"
        >
          🔧 API 상태 확인
        </button>
        <br />
        <button
          id="matching-btn"
          style="
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            font-size: 1.2em;
            font-family: 'BM Hanna Pro', cursive;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3);
          "
          onmouseover="this.style.backgroundColor='#ff5252'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(255, 107, 107, 0.4)';"
          onmouseout="this.style.backgroundColor='#ff6b6b'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(255, 107, 107, 0.3)';"
        >
          💕 AI 매칭 시작하기
        </button>
        <button
          id="view-matches-btn"
          style="
            background-color: #4ecdc4;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            font-size: 1.2em;
            font-family: 'BM Hanna Pro', cursive;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 15px;
            box-shadow: 0 4px 8px rgba(78, 205, 196, 0.3);
          "
          onmouseover="this.style.backgroundColor='#26d0ce'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(78, 205, 196, 0.4)';"
          onmouseout="this.style.backgroundColor='#4ecdc4'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(78, 205, 196, 0.3)';"
        >
          💑 매칭 결과 보기
        </button>
      </div>

      <!-- 매칭 진행 상태 표시 -->
      <div
        id="matching-progress"
        style="display: none; text-align: center; margin: 20px 0"
      >
        <div style="font-size: 1.2em; color: #5a3a22; margin-bottom: 10px">
          🔮 AI가 사주와 MBTI를 분석하여 최적의 매칭을 찾고 있습니다...
        </div>

        <!-- 진행률 바 -->
        <div
          style="
            background-color: #f3f3f3;
            border-radius: 10px;
            height: 20px;
            margin: 15px auto;
            width: 300px;
            max-width: 80%;
          "
        >
          <div
            id="progress-bar"
            style="
              background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
              height: 100%;
              border-radius: 10px;
              width: 0%;
              transition: width 0.3s ease;
            "
          ></div>
        </div>

        <!-- 진행 정보 -->
        <div
          id="progress-info"
          style="margin: 10px 0; font-size: 1em; color: #8a6d59"
        >
          <div id="progress-text">매칭 준비 중...</div>
          <div id="time-estimate" style="margin-top: 5px; font-size: 0.9em">
            예상 소요 시간 계산 중...
          </div>
        </div>

        <!-- 로딩 스피너 -->
        <div
          style="
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff6b6b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
          "
        ></div>
      </div>

      <div class="search-bar">
        <input
          type="text"
          id="search-input"
          placeholder="이름 또는 학번으로 검색..."
        />
      </div>

      {% if results %}
      <table class="results-table" id="results-table">
        <thead>
          <tr>
            <th>학번</th>
            <th>이름</th>
            <th>MBTI</th>
            <th>성별</th>
            <th>인스타그램</th>
            <th>매칭상태</th>
            <th>분석일시</th>
            <th>작업</th>
          </tr>
        </thead>
        <tbody>
          {% for result in results %}
          <tr>
            <td>{{ result.student_id }}</td>
            <td>{{ result.name }}</td>
            <td>{{ result.mbti }}</td>
            <td>{{ result.gender or '-' }}</td>
            <td>{{ result.instagram_id or '-' }}</td>
            <td>
              {% if result.is_matched %}
              <span style="color: #ff6b6b; font-weight: bold">✅ 매칭완료</span>
              {% else %}
              <span style="color: #4ecdc4; font-weight: bold">⏳ 대기중</span>
              {% endif %}
            </td>
            <td>{{ result.created_at }}</td>
            <td>
              <button
                class="action-btn view-btn"
                onclick="viewResult({{ result.id }})"
              >
                보기
              </button>
              <button
                class="action-btn delete-btn"
                onclick="deleteResult({{ result.id }})"
              >
                삭제
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="no-results">📝 아직 분석 결과가 없습니다.</div>
      {% endif %}
    </div>

    <!-- 상세보기 모달 -->
    <div id="detail-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="result-detail" class="result-detail">
          <!-- AJAX로 로드될 내용 -->
        </div>
      </div>
    </div>

    <!-- 매칭 결과 모달 -->
    <div id="matches-modal" class="modal">
      <div class="modal-content" style="max-width: 900px; max-height: 90vh">
        <span class="close" onclick="closeMatchesModal()">&times;</span>
        <h2 style="color: #5a3a22; margin-bottom: 20px; text-align: center">
          💑 AI 매칭 결과
        </h2>
        <div id="matches-content">
          <!-- AJAX로 로드될 매칭 결과 -->
        </div>
      </div>
    </div>

    <script>
      // 검색 기능
      document
        .getElementById("search-input")
        .addEventListener("input", function () {
          const searchTerm = this.value.toLowerCase();
          const rows = document.querySelectorAll("#results-table tbody tr");

          rows.forEach((row) => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          });
        });

      // 결과 상세보기
      async function viewResult(id) {
        try {
          const response = await fetch(`/admin/result/${id}`);
          const data = await response.json();

          if (response.ok) {
            document.getElementById("detail-modal").style.display = "block";

            document.getElementById("result-detail").innerHTML = `
                        <h3>📋 분석 결과 상세보기</h3>
                        <p><strong>학번:</strong> ${data.student_id}</p>
                        <p><strong>이름:</strong> ${data.name}</p>
                        <p><strong>MBTI:</strong> ${data.mbti}</p>
                        <p><strong>인스타그램:</strong> ${
                          data.instagram_id || "정보 없음"
                        }</p>
                        <p><strong>분석일시:</strong> ${data.created_at}</p>
                        <h4>🔮 사주 정보</h4>
                        <p>${data.saju_result}</p>
                        <h4>💬 AI 분석 결과</h4>
                        <p style="white-space: pre-wrap; line-height: 1.6;">${
                          data.ai_analysis
                        }</p>
                    `;
          } else {
            alert("결과를 불러오는 중 오류가 발생했습니다: " + data.error);
          }
        } catch (error) {
          alert("결과를 불러오는 중 오류가 발생했습니다: " + error.message);
        }
      }

      // 결과 삭제
      async function deleteResult(id) {
        if (
          confirm(
            "정말로 이 분석 결과를 삭제하시겠습니까?\n삭제된 데이터는 복구할 수 없습니다."
          )
        ) {
          try {
            const response = await fetch(`/admin/result/${id}`, {
              method: "DELETE",
            });
            const data = await response.json();

            if (response.ok) {
              alert("결과가 성공적으로 삭제되었습니다.");
              location.reload(); // 페이지 새로고침으로 목록 업데이트
            } else {
              alert("삭제 중 오류가 발생했습니다: " + data.error);
            }
          } catch (error) {
            alert("삭제 중 오류가 발생했습니다: " + error.message);
          }
        }
      }

      // 모달 닫기
      function closeModal() {
        document.getElementById("detail-modal").style.display = "none";
      }

      // 모달 외부 클릭으로 닫기
      window.onclick = function (event) {
        const modal = document.getElementById("detail-modal");
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };

      // ESC 키로 모달 닫기
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeModal();
        }
      });

      // 오늘의 분석 수 계산
      function calculateTodayStats() {
        const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD 형식
        const rows = document.querySelectorAll("#results-table tbody tr");
        let todayCount = 0;

        rows.forEach((row) => {
          const dateCell = row.cells[6]; // 분석일시 열
          if (dateCell) {
            const resultDate = dateCell.textContent.split(" ")[0]; // 날짜 부분만 추출
            if (resultDate === today) {
              todayCount++;
            }
          }
        });

        document.getElementById("today-count").textContent = todayCount;
      }

      // API 테스트 함수
      async function testAPI() {
        const btn = document.getElementById("api-test-btn");

        if (confirm("Gemini API 상태를 테스트하시겠습니까?")) {
          btn.disabled = true;
          btn.textContent = "🔄 API 테스트 중...";

          try {
            const response = await fetch("/admin/api-test");
            const data = await response.json();

            if (response.ok) {
              let message = "🔧 API 상태 테스트 결과:\n\n";

              // API 키 상태
              message += `API 키: ${
                data.api_key.valid ? "✅ 유효" : "❌ 오류"
              }\n`;
              message += `${data.api_key.message}\n\n`;

              // 사용 가능한 모델 목록
              if (data.available_models && data.available_models.length > 0) {
                message += `사용 가능한 모델들 (${data.available_models.length}개):\n`;
                data.available_models.slice(0, 5).forEach((model) => {
                  message += `  - ${model}\n`;
                });
                if (data.available_models.length > 5) {
                  message += `  ... 외 ${data.available_models.length - 5}개\n`;
                }
                message += "\n";
              }

              // 모델 상태
              message += "테스트한 모델 상태:\n";
              for (const [modelName, modelInfo] of Object.entries(
                data.models
              )) {
                message += `${modelName}: ${
                  modelInfo.valid ? "✅ 사용 가능" : "❌ 사용 불가"
                }\n`;
                message += `  ${modelInfo.message}\n`;
              }

              alert(message);
            } else {
              alert("API 테스트 중 오류가 발생했습니다: " + data.error);
            }
          } catch (error) {
            alert("API 테스트 요청 중 오류가 발생했습니다: " + error.message);
          } finally {
            btn.disabled = false;
            btn.textContent = "🔧 API 상태 확인";
          }
        }
      }

      // 매칭 시작 함수
      async function startMatching() {
        const btn = document.getElementById("matching-btn");
        const progressDiv = document.getElementById("matching-progress");
        const progressBar = document.getElementById("progress-bar");
        const progressText = document.getElementById("progress-text");
        const timeEstimate = document.getElementById("time-estimate");

        if (
          confirm(
            "AI 매칭을 시작하시겠습니까?\n모든 사용자 쌍에 대해 사주와 MBTI 호환성을 분석합니다."
          )
        ) {
          // 버튼 비활성화 및 진행 표시
          btn.disabled = true;
          btn.textContent = "🔄 매칭 진행 중...";
          progressDiv.style.display = "block";

          // 진행률 시뮬레이션 변수들
          let progress = 0;
          let startTime = Date.now();
          let totalUsers = {{ results|length }};

          // 실제 매칭 로직 기반 시간 계산
          let femaleCount = {{ results|selectattr("gender", "equalto", "female")|list|length }};
          let maleCount = {{ results|selectattr("gender", "equalto", "male")|list|length }};

          // 각 사용자마다 상위 3명과 AI 분석 (실제 로직)
          let totalAIAnalyses = Math.min(totalUsers * 3, femaleCount * maleCount);

          // AI 분석 시간 계산:
          // - AI 호출 전 딜레이: 0.3초
          // - AI 호출 자체: 평균 3-5초 (최대 10초 타임아웃)
          // - 5번마다 휴식: 1초
          // - 기타 처리 시간: 0.2초
          let avgAITime = 4.0; // AI 호출 평균 시간
          let restTime = Math.floor(totalAIAnalyses / 5) * 1.0; // 휴식 시간
          let totalProcessTime = totalAIAnalyses * 0.5; // 기타 처리

          let estimatedTotalTime = Math.max(
            totalAIAnalyses * avgAITime + restTime + totalProcessTime,
            60 // 최소 1분
          );

          // 진행률 업데이트 함수
          function updateProgress() {
            if (progress < 90) { // 실제 완료 전까지 90%까지만 표시
              progress += Math.random() * 5 + 1; // 1-6% 씩 랜덤 증가
              if (progress > 90) progress = 90;

              progressBar.style.width = progress + "%";

              // 현재 처리 중인 AI 분석 수 계산
              let currentAnalyses = Math.floor((progress / 100) * totalAIAnalyses);
              progressText.textContent = `${currentAnalyses}/${totalAIAnalyses} AI 분석 중... (${Math.floor(progress)}%)`;

              // 남은 시간 계산 (더 정확한 공식)
              let elapsedTime = (Date.now() - startTime) / 1000;
              let estimatedRemaining;

              if (progress > 5) {
                // 실제 진행률 기반 계산
                estimatedRemaining = ((100 - progress) / progress) * elapsedTime;
              } else {
                // 초기에는 예상 시간 사용
                estimatedRemaining = estimatedTotalTime;
              }

              // 최대 예상 시간 제한
              if (estimatedRemaining > estimatedTotalTime) {
                estimatedRemaining = estimatedTotalTime - elapsedTime;
              }

              if (estimatedRemaining > 60) {
                timeEstimate.textContent = `예상 남은 시간: 약 ${Math.ceil(estimatedRemaining / 60)}분`;
              } else if (estimatedRemaining > 0) {
                timeEstimate.textContent = `예상 남은 시간: 약 ${Math.ceil(estimatedRemaining)}초`;
              } else {
                timeEstimate.textContent = `거의 완료되었습니다...`;
              }

              // 1-3초 후 다시 업데이트
              setTimeout(updateProgress, Math.random() * 2000 + 1000);
            }
          }

          // 초기 예상 시간 표시
          if (estimatedTotalTime > 60) {
            timeEstimate.textContent = `예상 소요 시간: 약 ${Math.ceil(estimatedTotalTime / 60)}분 (${totalAIAnalyses}회 AI 분석)`;
          } else {
            timeEstimate.textContent = `예상 소요 시간: 약 ${Math.ceil(estimatedTotalTime)}초 (${totalAIAnalyses}회 AI 분석)`;
          }
          progressText.textContent = `매칭 준비 중... (총 ${totalUsers}명: 여자 ${femaleCount}명, 남자 ${maleCount}명)`;

          // 진행률 업데이트 시작
          setTimeout(updateProgress, 1000);

          try {
            const response = await fetch("/admin/matching", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            });

            const data = await response.json();

            // 완료 시 진행률을 100%로 설정
            progressBar.style.width = "100%";
            progressText.textContent = `AI 분석 완료! (총 ${totalAIAnalyses}회 분석)`;
            let finalElapsed = (Date.now() - startTime) / 1000;
            if (finalElapsed > 60) {
              timeEstimate.textContent = `실제 소요 시간: ${Math.floor(finalElapsed / 60)}분 ${Math.floor(finalElapsed % 60)}초`;
            } else {
              timeEstimate.textContent = `실제 소요 시간: ${Math.floor(finalElapsed)}초`;
            }

            if (response.ok) {
              setTimeout(() => {
                alert(data.message);
                updateMatchesCount(); // 매칭 결과 수 업데이트
                updateStatistics(); // 미매칭 사용자 통계 업데이트
              }, 500);
            } else {
              alert("매칭 중 오류가 발생했습니다: " + data.error);
            }
          } catch (error) {
            alert("매칭 요청 중 오류가 발생했습니다: " + error.message);
          } finally {
            // 버튼 복원 및 진행 표시 숨김
            setTimeout(() => {
              btn.disabled = false;
              btn.textContent = "💕 AI 매칭 시작하기";
              progressDiv.style.display = "none";

              // 진행률 초기화
              progressBar.style.width = "0%";
              progressText.textContent = "매칭 준비 중...";
              timeEstimate.textContent = "예상 소요 시간 계산 중...";
            }, 1500);
          }
        }
      }

      // 매칭 결과 보기 함수
      async function viewMatches() {
        try {
          const response = await fetch("/admin/matching/results");
          const data = await response.json();

          if (response.ok) {
            displayMatches(data.matches);
          } else {
            alert("매칭 결과를 불러오는 중 오류가 발생했습니다: " + data.error);
          }
        } catch (error) {
          alert(
            "매칭 결과를 불러오는 중 오류가 발생했습니다: " + error.message
          );
        }
      }

      // 페이지네이션 변수들
      let allMatches = [];
      let currentPage = 1;
      const matchesPerPage = 50;

      // 매칭 결과 표시 함수 (페이지네이션 포함)
      function displayMatches(matches) {
        allMatches = matches;
        currentPage = 1;

        const modal = document.getElementById("matches-modal");
        const content = document.getElementById("matches-content");

        if (matches.length === 0) {
          content.innerHTML =
            '<div style="text-align: center; padding: 40px; color: #666;">💔 아직 매칭 결과가 없습니다. 먼저 AI 매칭을 실행해주세요.</div>';
        } else {
          updateMatchesPage();
        }

        modal.style.display = "block";
      }

      // 특정 페이지의 매칭 결과 업데이트
      function updateMatchesPage() {
        const content = document.getElementById("matches-content");
        const totalPages = Math.ceil(allMatches.length / matchesPerPage);
        const startIndex = (currentPage - 1) * matchesPerPage;
        const endIndex = Math.min(startIndex + matchesPerPage, allMatches.length);
        const currentMatches = allMatches.slice(startIndex, endIndex);

        let html = `
          <!-- 페이지네이션 헤더 -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background-color: #f8f5f0; border-radius: 8px; border: 2px solid #bda08c;">
            <div style="font-size: 1.1em; color: #5a3a22; font-weight: bold;">
              📊 총 ${allMatches.length}개 결과 | ${currentPage}/${totalPages} 페이지 (${startIndex + 1}-${endIndex}번째)
            </div>
            <div>
              <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}
                style="padding: 8px 12px; margin: 0 5px; border: none; border-radius: 4px; background-color: ${currentPage === 1 ? '#ccc' : '#a84448'}; color: white; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'};">
                ◀ 이전
              </button>
              <span style="margin: 0 10px; color: #5a3a22; font-weight: bold;">${currentPage} / ${totalPages}</span>
              <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}
                style="padding: 8px 12px; margin: 0 5px; border: none; border-radius: 4px; background-color: ${currentPage === totalPages ? '#ccc' : '#a84448'}; color: white; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'};">
                다음 ▶
              </button>
            </div>
          </div>

          <!-- 매칭 결과 리스트 -->
          <div style="max-height: 60vh; overflow-y: auto;">
        `;

        currentMatches.forEach((match, index) => {
          const scoreColor =
            match.compatibility_score >= 80
              ? "#ff6b6b"
              : match.compatibility_score >= 60
              ? "#ffa726"
              : match.compatibility_score >= 40
              ? "#4ecdc4"
              : "#666";

          const globalIndex = startIndex + index + 1;

          html += `
            <div style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background-color: #fafafa;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div style="font-size: 1.1em; font-weight: bold; color: #5a3a22;">
                  <span style="background-color: #bda08c; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.9em; margin-right: 10px;">#${globalIndex}</span>
                  ${match.user1.name} 💕 ${match.user2.name}
                </div>
                <div style="font-size: 1.2em; font-weight: bold; color: ${scoreColor};">
                  호환성: ${match.compatibility_score}점
                </div>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <div style="flex: 1;">
                  <strong>${match.user1.name}</strong> (${match.user1.mbti})
                  ${
                    match.user1.instagram
                      ? `<br><small>@${match.user1.instagram}</small>`
                      : ""
                  }
                </div>
                <div style="flex: 1; text-align: right;">
                  <strong>${match.user2.name}</strong> (${match.user2.mbti})
                  ${
                    match.user2.instagram
                      ? `<br><small>@${match.user2.instagram}</small>`
                      : ""
                  }
                </div>
              </div>
              <div style="background-color: white; padding: 10px; border-radius: 4px; border-left: 3px solid ${scoreColor};">
                <strong>매칭 분석:</strong><br>
                ${match.matching_reason}
              </div>
              <div style="text-align: right; margin-top: 5px;">
                <small style="color: #666;">${match.created_at}</small>
              </div>
            </div>
          `;
        });

        html += `
          </div>

          <!-- 페이지네이션 푸터 -->
          <div style="display: flex; justify-content: center; align-items: center; margin-top: 20px; padding: 15px; background-color: #f8f5f0; border-radius: 8px; border: 2px solid #bda08c;">
            <button onclick="changePage(1)" ${currentPage === 1 ? 'disabled' : ''}
              style="padding: 8px 12px; margin: 0 5px; border: none; border-radius: 4px; background-color: ${currentPage === 1 ? '#ccc' : '#8a6d59'}; color: white; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'};">
              첫 페이지
            </button>
            <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}
              style="padding: 8px 12px; margin: 0 5px; border: none; border-radius: 4px; background-color: ${currentPage === 1 ? '#ccc' : '#a84448'}; color: white; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'};">
              ◀ 이전
            </button>

            <div style="margin: 0 15px;">
              <select onchange="changePage(parseInt(this.value))" style="padding: 8px; border: 2px solid #bda08c; border-radius: 4px; font-family: 'BM Hanna Pro', cursive;">
        `;

        for (let i = 1; i <= totalPages; i++) {
          html += `<option value="${i}" ${i === currentPage ? 'selected' : ''}>${i}페이지</option>`;
        }

        html += `
              </select>
            </div>

            <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}
              style="padding: 8px 12px; margin: 0 5px; border: none; border-radius: 4px; background-color: ${currentPage === totalPages ? '#ccc' : '#a84448'}; color: white; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'};">
              다음 ▶
            </button>
            <button onclick="changePage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}
              style="padding: 8px 12px; margin: 0 5px; border: none; border-radius: 4px; background-color: ${currentPage === totalPages ? '#ccc' : '#8a6d59'}; color: white; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'};">
              마지막 페이지
            </button>
          </div>

          <!-- 키보드 단축키 안내 -->
          <div style="text-align: center; margin-top: 10px; padding: 10px; background-color: #f0f0f0; border-radius: 4px; font-size: 0.9em; color: #666;">
            ⌨️ <strong>키보드 단축키:</strong> ← 이전 페이지 | → 다음 페이지 | Home 첫 페이지 | End 마지막 페이지 | ESC 닫기
          </div>
        `;

        content.innerHTML = html;
      }

      // 페이지 변경 함수
      function changePage(newPage) {
        const totalPages = Math.ceil(allMatches.length / matchesPerPage);

        if (newPage >= 1 && newPage <= totalPages) {
          currentPage = newPage;
          updateMatchesPage();

          // 맨 위로 스크롤
          const content = document.getElementById("matches-content");
          content.scrollTop = 0;
        }
      }

      // 매칭 모달 닫기 함수
      function closeMatchesModal() {
        document.getElementById("matches-modal").style.display = "none";
      }

      // 매칭 결과 수 업데이트 함수
      async function updateMatchesCount() {
        try {
          const matchesCountElement = document.getElementById("matches-count");

          // 로딩 상태 표시
          matchesCountElement.textContent = "로딩...";
          matchesCountElement.style.color = "#8a6d59";

          const response = await fetch("/admin/matching/results");
          const data = await response.json();

          if (response.ok) {
            matchesCountElement.textContent = data.matches.length;
            matchesCountElement.style.color = "#a84448";

            // 성공 애니메이션
            matchesCountElement.style.transform = "scale(1.1)";
            setTimeout(() => {
              matchesCountElement.style.transform = "scale(1)";
            }, 300);

            console.log(`✅ 매칭 결과 수 업데이트 완료: ${data.matches.length}개`);
          } else {
            matchesCountElement.textContent = "오류";
            matchesCountElement.style.color = "#ff6b6b";
          }
        } catch (error) {
          console.error("매칭 수 업데이트 중 오류:", error);
          document.getElementById("matches-count").textContent = "오류";
          document.getElementById("matches-count").style.color = "#ff6b6b";
        }
      }

      // 페이지 새로고침 없이 통계 업데이트 함수
      async function updateStatistics() {
        try {
          // 관리자 페이지 데이터 다시 가져오기
          const response = await fetch("/admin");
          const html = await response.text();

          // 새로운 HTML에서 통계 데이터 추출
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = html;

          // 미매칭 여자 사용자 수 업데이트
          const newUnmatchedFemaleElement = tempDiv.querySelector('.stat-card:nth-child(5) .stat-number');
          if (newUnmatchedFemaleElement) {
            const currentElement = document.querySelector('.stat-card:nth-child(5) .stat-number');
            if (currentElement && currentElement.textContent !== newUnmatchedFemaleElement.textContent) {
              currentElement.textContent = newUnmatchedFemaleElement.textContent;
              // 업데이트 애니메이션
              currentElement.style.transform = "scale(1.1)";
              setTimeout(() => {
                currentElement.style.transform = "scale(1)";
              }, 300);
            }
          }

          // 미매칭 남자 사용자 수 업데이트
          const newUnmatchedMaleElement = tempDiv.querySelector('.stat-card:nth-child(6) .stat-number');
          if (newUnmatchedMaleElement) {
            const currentElement = document.querySelector('.stat-card:nth-child(6) .stat-number');
            if (currentElement && currentElement.textContent !== newUnmatchedMaleElement.textContent) {
              currentElement.textContent = newUnmatchedMaleElement.textContent;
              // 업데이트 애니메이션
              currentElement.style.transform = "scale(1.1)";
              setTimeout(() => {
                currentElement.style.transform = "scale(1)";
              }, 300);
            }
          }

          console.log("✅ 통계 정보 업데이트 완료");
        } catch (error) {
          console.error("통계 업데이트 중 오류:", error);
        }
      }

      // 이벤트 리스너 등록
      document
        .getElementById("api-test-btn")
        .addEventListener("click", testAPI);
      document
        .getElementById("matching-btn")
        .addEventListener("click", startMatching);
      document
        .getElementById("view-matches-btn")
        .addEventListener("click", viewMatches);

      // 매칭 모달 외부 클릭으로 닫기
      window.addEventListener("click", function (event) {
        const modal = document.getElementById("matches-modal");
        if (event.target == modal) {
          modal.style.display = "none";
        }
      });

      // 키보드 단축키 (ESC, 좌우 화살표)
      document.addEventListener("keydown", function (event) {
        const modal = document.getElementById("matches-modal");

        if (event.key === "Escape") {
          if (modal.style.display === "block") {
            modal.style.display = "none";
          }
        }

        // 매칭 결과 모달이 열려있을 때만 페이지네이션 단축키 작동
        if (modal.style.display === "block" && allMatches.length > 0) {
          const totalPages = Math.ceil(allMatches.length / matchesPerPage);

          if (event.key === "ArrowLeft" && currentPage > 1) {
            event.preventDefault();
            changePage(currentPage - 1);
          } else if (event.key === "ArrowRight" && currentPage < totalPages) {
            event.preventDefault();
            changePage(currentPage + 1);
          } else if (event.key === "Home") {
            event.preventDefault();
            changePage(1);
          } else if (event.key === "End") {
            event.preventDefault();
            changePage(totalPages);
          }
        }
      });

      // 페이지 로드 시 오늘 통계 계산 및 매칭 수 업데이트
      document.addEventListener("DOMContentLoaded", function () {
        calculateTodayStats();
        updateMatchesCount();
      });

      // Service Worker 메시지 수신 처리 (알림 클릭 시 페이지 이동)
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.addEventListener('message', function(event) {
          console.log('📨 Service Worker 메시지 수신:', event.data);

          if (event.data && event.data.type === 'NAVIGATE' && event.data.url) {
            console.log(`🔄 페이지 이동: ${window.location.href} → ${event.data.url}`);
            window.location.href = event.data.url;
          }
        });
      }
    </script>
  </body>
</html>
