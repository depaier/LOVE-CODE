<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>관리자 페이지 - LOVE-CODE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nanum+Brush+Script&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Nanum Brush Script", cursive;
        background-color: #fdfaf3;
        margin: 0;
        padding: 20px;
        color: #3a3a3a;
      }

      .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: #ffffff;
        padding: 30px;
        border: 3px solid #8a6d59;
        border-radius: 8px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      h1 {
        font-size: 2.5em;
        color: #5a3a22;
        text-align: center;
        margin-bottom: 30px;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background-color: #f8f5f0;
        padding: 20px;
        border-radius: 6px;
        border: 2px solid #bda08c;
        text-align: center;
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #a84448;
      }

      .stat-label {
        font-size: 1.2em;
        color: #5a3a22;
      }

      .search-bar {
        margin-bottom: 20px;
        text-align: center;
      }

      .search-bar input {
        padding: 10px;
        border: 2px solid #bda08c;
        border-radius: 4px;
        font-size: 1em;
        width: 300px;
        font-family: "Nanum Brush Script", cursive;
      }

      .results-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .results-table th,
      .results-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
      }

      .results-table th {
        background-color: #f8f5f0;
        color: #5a3a22;
        font-size: 1.1em;
      }

      .results-table tr:hover {
        background-color: #f9f6f2;
      }

      .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        font-family: "Nanum Brush Script", cursive;
        margin-right: 5px;
      }

      .view-btn {
        background-color: #a84448;
        color: white;
      }

      .delete-btn {
        background-color: #666;
        color: white;
      }

      .back-btn {
        display: inline-block;
        padding: 10px 20px;
        background-color: #8a6d59;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        margin-bottom: 20px;
        font-family: "Nanum Brush Script", cursive;
      }

      .back-btn:hover {
        background-color: #6d4a3d;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: #ffffff;
        margin: 5% auto;
        padding: 20px;
        border: 3px solid #8a6d59;
        border-radius: 8px;
        width: 90%;
        max-width: 700px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 2em;
        cursor: pointer;
        color: #5a3a22;
      }

      .result-detail h3 {
        color: #5a3a22;
        margin-bottom: 10px;
      }

      .result-detail p {
        margin-bottom: 15px;
        line-height: 1.6;
      }

      .no-results {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 1.2em;
      }

      @media (max-width: 768px) {
        .admin-container {
          padding: 15px;
          margin: 10px;
        }

        .stats {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .results-table {
          font-size: 0.9em;
        }

        .results-table th,
        .results-table td {
          padding: 8px;
        }

        .search-bar input {
          width: 100%;
          max-width: 300px;
        }

        .action-btn {
          padding: 4px 8px;
          font-size: 0.8em;
          margin-right: 3px;
        }
      }

      @media (max-width: 480px) {
        .admin-container {
          padding: 10px;
          margin: 5px;
          border-radius: 4px;
        }

        h1 {
          font-size: 2em;
        }

        .results-table {
          font-size: 0.8em;
        }

        .results-table th:nth-child(4),
        .results-table td:nth-child(4),
        .results-table th:nth-child(5),
        .results-table td:nth-child(5),
        .results-table th:nth-child(6),
        .results-table td:nth-child(6) {
          display: none; /* 인스타그램, 매칭상태, 분석일시 열 숨기기 */
        }

        .back-btn {
          font-size: 0.9em;
          padding: 8px 16px;
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <h1>📊 관리자 페이지</h1>

      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
        "
      >
        <a href="/" class="back-btn">← 메인 페이지로 돌아가기</a>
        <a href="/admin/logout" class="back-btn" style="background-color: #666"
          >로그아웃</a
        >
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="total-count">{{ results|length }}</div>
          <div class="stat-label">총 분석 수</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="today-count">0</div>
          <div class="stat-label">오늘 분석 수</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="unique-users">{{ results|length }}</div>
          <div class="stat-label">등록된 사용자</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="matches-count">0</div>
          <div class="stat-label">매칭 결과 수</div>
        </div>
      </div>

      <!-- 매칭 기능 섹션 -->
      <div style="margin: 30px 0; text-align: center">
        <button
          id="api-test-btn"
          style="
            background-color: #666;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            font-size: 1.2em;
            font-family: 'Nanum Brush Script', cursive;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(102, 102, 102, 0.3);
            margin-bottom: 15px;
          "
          onmouseover="this.style.backgroundColor='#555'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(102, 102, 102, 0.4)';"
          onmouseout="this.style.backgroundColor='#666'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(102, 102, 102, 0.3)';"
        >
          🔧 API 상태 확인
        </button>
        <br />
        <button
          id="matching-btn"
          style="
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            font-size: 1.2em;
            font-family: 'Nanum Brush Script', cursive;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3);
          "
          onmouseover="this.style.backgroundColor='#ff5252'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(255, 107, 107, 0.4)';"
          onmouseout="this.style.backgroundColor='#ff6b6b'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(255, 107, 107, 0.3)';"
        >
          💕 AI 매칭 시작하기
        </button>
        <button
          id="view-matches-btn"
          style="
            background-color: #4ecdc4;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            font-size: 1.2em;
            font-family: 'Nanum Brush Script', cursive;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 15px;
            box-shadow: 0 4px 8px rgba(78, 205, 196, 0.3);
          "
          onmouseover="this.style.backgroundColor='#26d0ce'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(78, 205, 196, 0.4)';"
          onmouseout="this.style.backgroundColor='#4ecdc4'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(78, 205, 196, 0.3)';"
        >
          💑 매칭 결과 보기
        </button>
      </div>

      <!-- 매칭 진행 상태 표시 -->
      <div
        id="matching-progress"
        style="display: none; text-align: center; margin: 20px 0"
      >
        <div style="font-size: 1.2em; color: #5a3a22; margin-bottom: 10px">
          🔮 AI가 사주와 MBTI를 분석하여 최적의 매칭을 찾고 있습니다...
        </div>
        <div
          style="
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff6b6b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
          "
        ></div>
      </div>

      <div class="search-bar">
        <input
          type="text"
          id="search-input"
          placeholder="이름 또는 학번으로 검색..."
        />
      </div>

      {% if results %}
      <table class="results-table" id="results-table">
        <thead>
          <tr>
            <th>학번</th>
            <th>이름</th>
            <th>MBTI</th>
            <th>성별</th>
            <th>인스타그램</th>
            <th>매칭상태</th>
            <th>분석일시</th>
            <th>작업</th>
          </tr>
        </thead>
        <tbody>
          {% for result in results %}
          <tr>
            <td>{{ result.student_id }}</td>
            <td>{{ result.name }}</td>
            <td>{{ result.mbti }}</td>
            <td>{{ result.gender or '-' }}</td>
            <td>{{ result.instagram_id or '-' }}</td>
            <td>
              {% if result.is_matched %}
              <span style="color: #ff6b6b; font-weight: bold">✅ 매칭완료</span>
              {% else %}
              <span style="color: #4ecdc4; font-weight: bold">⏳ 대기중</span>
              {% endif %}
            </td>
            <td>{{ result.created_at }}</td>
            <td>
              <button
                class="action-btn view-btn"
                onclick="viewResult({{ result.id }})"
              >
                보기
              </button>
              <button
                class="action-btn delete-btn"
                onclick="deleteResult({{ result.id }})"
              >
                삭제
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="no-results">📝 아직 분석 결과가 없습니다.</div>
      {% endif %}
    </div>

    <!-- 상세보기 모달 -->
    <div id="detail-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="result-detail" class="result-detail">
          <!-- AJAX로 로드될 내용 -->
        </div>
      </div>
    </div>

    <!-- 매칭 결과 모달 -->
    <div id="matches-modal" class="modal">
      <div class="modal-content" style="max-width: 800px">
        <span class="close" onclick="closeMatchesModal()">&times;</span>
        <h2 style="color: #5a3a22; margin-bottom: 20px; text-align: center">
          💑 AI 매칭 결과
        </h2>
        <div id="matches-content">
          <!-- AJAX로 로드될 매칭 결과 -->
        </div>
      </div>
    </div>

    <script>
      // 검색 기능
      document
        .getElementById("search-input")
        .addEventListener("input", function () {
          const searchTerm = this.value.toLowerCase();
          const rows = document.querySelectorAll("#results-table tbody tr");

          rows.forEach((row) => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          });
        });

      // 결과 상세보기
      async function viewResult(id) {
        try {
          const response = await fetch(`/admin/result/${id}`);
          const data = await response.json();

          if (response.ok) {
            document.getElementById("detail-modal").style.display = "block";

            document.getElementById("result-detail").innerHTML = `
                        <h3>📋 분석 결과 상세보기</h3>
                        <p><strong>학번:</strong> ${data.student_id}</p>
                        <p><strong>이름:</strong> ${data.name}</p>
                        <p><strong>MBTI:</strong> ${data.mbti}</p>
                        <p><strong>인스타그램:</strong> ${
                          data.instagram_id || "정보 없음"
                        }</p>
                        <p><strong>분석일시:</strong> ${data.created_at}</p>
                        <h4>🔮 사주 정보</h4>
                        <p>${data.saju_result}</p>
                        <h4>💬 AI 분석 결과</h4>
                        <p style="white-space: pre-wrap; line-height: 1.6;">${
                          data.ai_analysis
                        }</p>
                    `;
          } else {
            alert("결과를 불러오는 중 오류가 발생했습니다: " + data.error);
          }
        } catch (error) {
          alert("결과를 불러오는 중 오류가 발생했습니다: " + error.message);
        }
      }

      // 결과 삭제
      async function deleteResult(id) {
        if (
          confirm(
            "정말로 이 분석 결과를 삭제하시겠습니까?\n삭제된 데이터는 복구할 수 없습니다."
          )
        ) {
          try {
            const response = await fetch(`/admin/result/${id}`, {
              method: "DELETE",
            });
            const data = await response.json();

            if (response.ok) {
              alert("결과가 성공적으로 삭제되었습니다.");
              location.reload(); // 페이지 새로고침으로 목록 업데이트
            } else {
              alert("삭제 중 오류가 발생했습니다: " + data.error);
            }
          } catch (error) {
            alert("삭제 중 오류가 발생했습니다: " + error.message);
          }
        }
      }

      // 모달 닫기
      function closeModal() {
        document.getElementById("detail-modal").style.display = "none";
      }

      // 모달 외부 클릭으로 닫기
      window.onclick = function (event) {
        const modal = document.getElementById("detail-modal");
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };

      // ESC 키로 모달 닫기
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeModal();
        }
      });

      // 오늘의 분석 수 계산
      function calculateTodayStats() {
        const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD 형식
        const rows = document.querySelectorAll("#results-table tbody tr");
        let todayCount = 0;

        rows.forEach((row) => {
          const dateCell = row.cells[6]; // 분석일시 열
          if (dateCell) {
            const resultDate = dateCell.textContent.split(" ")[0]; // 날짜 부분만 추출
            if (resultDate === today) {
              todayCount++;
            }
          }
        });

        document.getElementById("today-count").textContent = todayCount;
      }

      // API 테스트 함수
      async function testAPI() {
        const btn = document.getElementById("api-test-btn");

        if (confirm("Gemini API 상태를 테스트하시겠습니까?")) {
          btn.disabled = true;
          btn.textContent = "🔄 API 테스트 중...";

          try {
            const response = await fetch("/admin/api-test");
            const data = await response.json();

            if (response.ok) {
              let message = "🔧 API 상태 테스트 결과:\n\n";

              // API 키 상태
              message += `API 키: ${
                data.api_key.valid ? "✅ 유효" : "❌ 오류"
              }\n`;
              message += `${data.api_key.message}\n\n`;

              // 사용 가능한 모델 목록
              if (data.available_models && data.available_models.length > 0) {
                message += `사용 가능한 모델들 (${data.available_models.length}개):\n`;
                data.available_models.slice(0, 5).forEach((model) => {
                  message += `  - ${model}\n`;
                });
                if (data.available_models.length > 5) {
                  message += `  ... 외 ${data.available_models.length - 5}개\n`;
                }
                message += "\n";
              }

              // 모델 상태
              message += "테스트한 모델 상태:\n";
              for (const [modelName, modelInfo] of Object.entries(
                data.models
              )) {
                message += `${modelName}: ${
                  modelInfo.valid ? "✅ 사용 가능" : "❌ 사용 불가"
                }\n`;
                message += `  ${modelInfo.message}\n`;
              }

              alert(message);
            } else {
              alert("API 테스트 중 오류가 발생했습니다: " + data.error);
            }
          } catch (error) {
            alert("API 테스트 요청 중 오류가 발생했습니다: " + error.message);
          } finally {
            btn.disabled = false;
            btn.textContent = "🔧 API 상태 확인";
          }
        }
      }

      // 매칭 시작 함수
      async function startMatching() {
        const btn = document.getElementById("matching-btn");
        const progressDiv = document.getElementById("matching-progress");

        if (
          confirm(
            "AI 매칭을 시작하시겠습니까?\n모든 사용자 쌍에 대해 사주와 MBTI 호환성을 분석합니다."
          )
        ) {
          // 버튼 비활성화 및 진행 표시
          btn.disabled = true;
          btn.textContent = "🔄 매칭 진행 중...";
          progressDiv.style.display = "block";

          try {
            const response = await fetch("/admin/matching", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            });

            const data = await response.json();

            if (response.ok) {
              alert(data.message);
              updateMatchesCount(); // 매칭 결과 수 업데이트
            } else {
              alert("매칭 중 오류가 발생했습니다: " + data.error);
            }
          } catch (error) {
            alert("매칭 요청 중 오류가 발생했습니다: " + error.message);
          } finally {
            // 버튼 복원 및 진행 표시 숨김
            btn.disabled = false;
            btn.textContent = "💕 AI 매칭 시작하기";
            progressDiv.style.display = "none";
          }
        }
      }

      // 매칭 결과 보기 함수
      async function viewMatches() {
        try {
          const response = await fetch("/admin/matching/results");
          const data = await response.json();

          if (response.ok) {
            displayMatches(data.matches);
          } else {
            alert("매칭 결과를 불러오는 중 오류가 발생했습니다: " + data.error);
          }
        } catch (error) {
          alert(
            "매칭 결과를 불러오는 중 오류가 발생했습니다: " + error.message
          );
        }
      }

      // 매칭 결과 표시 함수
      function displayMatches(matches) {
        const modal = document.getElementById("matches-modal");
        const content = document.getElementById("matches-content");

        if (matches.length === 0) {
          content.innerHTML =
            '<div style="text-align: center; padding: 40px; color: #666;">💔 아직 매칭 결과가 없습니다. 먼저 AI 매칭을 실행해주세요.</div>';
        } else {
          let html = '<div style="max-height: 70vh; overflow-y: auto;">';

          matches.forEach((match, index) => {
            const scoreColor =
              match.compatibility_score >= 80
                ? "#ff6b6b"
                : match.compatibility_score >= 60
                ? "#ffa726"
                : match.compatibility_score >= 40
                ? "#4ecdc4"
                : "#666";

            html += `
              <div style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background-color: #fafafa;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <div style="font-size: 1.1em; font-weight: bold; color: #5a3a22;">
                    ${match.user1.name} 💕 ${match.user2.name}
                  </div>
                  <div style="font-size: 1.2em; font-weight: bold; color: ${scoreColor};">
                    호환성: ${match.compatibility_score}점
                  </div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                  <div style="flex: 1;">
                    <strong>${match.user1.name}</strong> (${match.user1.mbti})
                    ${
                      match.user1.instagram
                        ? `<br><small>@${match.user1.instagram}</small>`
                        : ""
                    }
                  </div>
                  <div style="flex: 1; text-align: right;">
                    <strong>${match.user2.name}</strong> (${match.user2.mbti})
                    ${
                      match.user2.instagram
                        ? `<br><small>@${match.user2.instagram}</small>`
                        : ""
                    }
                  </div>
                </div>
                <div style="background-color: white; padding: 10px; border-radius: 4px; border-left: 3px solid ${scoreColor};">
                  <strong>매칭 분석:</strong><br>
                  ${match.matching_reason}
                </div>
                <div style="text-align: right; margin-top: 5px;">
                  <small style="color: #666;">${match.created_at}</small>
                </div>
              </div>
            `;
          });

          html += "</div>";
          content.innerHTML = html;
        }

        modal.style.display = "block";
      }

      // 매칭 모달 닫기 함수
      function closeMatchesModal() {
        document.getElementById("matches-modal").style.display = "none";
      }

      // 매칭 결과 수 업데이트 함수
      async function updateMatchesCount() {
        try {
          const response = await fetch("/admin/matching/results");
          const data = await response.json();
          if (response.ok) {
            document.getElementById("matches-count").textContent =
              data.matches.length;
          }
        } catch (error) {
          console.error("매칭 수 업데이트 중 오류:", error);
        }
      }

      // 이벤트 리스너 등록
      document
        .getElementById("api-test-btn")
        .addEventListener("click", testAPI);
      document
        .getElementById("matching-btn")
        .addEventListener("click", startMatching);
      document
        .getElementById("view-matches-btn")
        .addEventListener("click", viewMatches);

      // 매칭 모달 외부 클릭으로 닫기
      window.addEventListener("click", function (event) {
        const modal = document.getElementById("matches-modal");
        if (event.target == modal) {
          modal.style.display = "none";
        }
      });

      // ESC 키로 매칭 모달 닫기
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          const modal = document.getElementById("matches-modal");
          if (modal.style.display === "block") {
            modal.style.display = "none";
          }
        }
      });

      // 페이지 로드 시 오늘 통계 계산 및 매칭 수 업데이트
      document.addEventListener("DOMContentLoaded", function () {
        calculateTodayStats();
        updateMatchesCount();
      });
    </script>
  </body>
</html>
