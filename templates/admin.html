<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê´€ë¦¬ì í˜ì´ì§€ - LOVE-CODE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nanum+Brush+Script&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Nanum Brush Script", cursive;
        background-color: #fdfaf3;
        margin: 0;
        padding: 20px;
        color: #3a3a3a;
      }

      .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: #ffffff;
        padding: 30px;
        border: 3px solid #8a6d59;
        border-radius: 8px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      h1 {
        font-size: 2.5em;
        color: #5a3a22;
        text-align: center;
        margin-bottom: 30px;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background-color: #f8f5f0;
        padding: 20px;
        border-radius: 6px;
        border: 2px solid #bda08c;
        text-align: center;
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #a84448;
      }

      .stat-label {
        font-size: 1.2em;
        color: #5a3a22;
      }

      .search-bar {
        margin-bottom: 20px;
        text-align: center;
      }

      .search-bar input {
        padding: 10px;
        border: 2px solid #bda08c;
        border-radius: 4px;
        font-size: 1em;
        width: 300px;
        font-family: "Nanum Brush Script", cursive;
      }

      .results-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .results-table th,
      .results-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
      }

      .results-table th {
        background-color: #f8f5f0;
        color: #5a3a22;
        font-size: 1.1em;
      }

      .results-table tr:hover {
        background-color: #f9f6f2;
      }

      .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        font-family: "Nanum Brush Script", cursive;
        margin-right: 5px;
      }

      .view-btn {
        background-color: #a84448;
        color: white;
      }

      .delete-btn {
        background-color: #666;
        color: white;
      }

      .back-btn {
        display: inline-block;
        padding: 10px 20px;
        background-color: #8a6d59;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        margin-bottom: 20px;
        font-family: "Nanum Brush Script", cursive;
      }

      .back-btn:hover {
        background-color: #6d4a3d;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: #ffffff;
        margin: 5% auto;
        padding: 20px;
        border: 3px solid #8a6d59;
        border-radius: 8px;
        width: 90%;
        max-width: 700px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 2em;
        cursor: pointer;
        color: #5a3a22;
      }

      .result-detail h3 {
        color: #5a3a22;
        margin-bottom: 10px;
      }

      .result-detail p {
        margin-bottom: 15px;
        line-height: 1.6;
      }

      .no-results {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 1.2em;
      }

      @media (max-width: 768px) {
        .admin-container {
          padding: 15px;
          margin: 10px;
        }

        .stats {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .results-table {
          font-size: 0.9em;
        }

        .results-table th,
        .results-table td {
          padding: 8px;
        }

        .search-bar input {
          width: 100%;
          max-width: 300px;
        }

        .action-btn {
          padding: 4px 8px;
          font-size: 0.8em;
          margin-right: 3px;
        }
      }

      @media (max-width: 480px) {
        .admin-container {
          padding: 10px;
          margin: 5px;
          border-radius: 4px;
        }

        h1 {
          font-size: 2em;
        }

        .results-table {
          font-size: 0.8em;
        }

        .results-table th:nth-child(4),
        .results-table td:nth-child(4),
        .results-table th:nth-child(5),
        .results-table td:nth-child(5),
        .results-table th:nth-child(6),
        .results-table td:nth-child(6) {
          display: none; /* ì¸ìŠ¤íƒ€ê·¸ë¨, ë§¤ì¹­ìƒíƒœ, ë¶„ì„ì¼ì‹œ ì—´ ìˆ¨ê¸°ê¸° */
        }

        .back-btn {
          font-size: 0.9em;
          padding: 8px 16px;
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <h1>ğŸ“Š ê´€ë¦¬ì í˜ì´ì§€</h1>

      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
        "
      >
        <a href="/" class="back-btn">â† ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
        <a href="/admin/logout" class="back-btn" style="background-color: #666"
          >ë¡œê·¸ì•„ì›ƒ</a
        >
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="total-count">{{ results|length }}</div>
          <div class="stat-label">ì´ ë¶„ì„ ìˆ˜</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="today-count">0</div>
          <div class="stat-label">ì˜¤ëŠ˜ ë¶„ì„ ìˆ˜</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="unique-users">{{ results|length }}</div>
          <div class="stat-label">ë“±ë¡ëœ ì‚¬ìš©ì</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="matches-count">0</div>
          <div class="stat-label">ë§¤ì¹­ ê²°ê³¼ ìˆ˜</div>
        </div>
      </div>

      <!-- ë§¤ì¹­ ê¸°ëŠ¥ ì„¹ì…˜ -->
      <div style="margin: 30px 0; text-align: center">
        <button
          id="api-test-btn"
          style="
            background-color: #666;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            font-size: 1.2em;
            font-family: 'Nanum Brush Script', cursive;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(102, 102, 102, 0.3);
            margin-bottom: 15px;
          "
          onmouseover="this.style.backgroundColor='#555'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(102, 102, 102, 0.4)';"
          onmouseout="this.style.backgroundColor='#666'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(102, 102, 102, 0.3)';"
        >
          ğŸ”§ API ìƒíƒœ í™•ì¸
        </button>
        <br />
        <button
          id="matching-btn"
          style="
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            font-size: 1.2em;
            font-family: 'Nanum Brush Script', cursive;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3);
          "
          onmouseover="this.style.backgroundColor='#ff5252'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(255, 107, 107, 0.4)';"
          onmouseout="this.style.backgroundColor='#ff6b6b'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(255, 107, 107, 0.3)';"
        >
          ğŸ’• AI ë§¤ì¹­ ì‹œì‘í•˜ê¸°
        </button>
        <button
          id="view-matches-btn"
          style="
            background-color: #4ecdc4;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            font-size: 1.2em;
            font-family: 'Nanum Brush Script', cursive;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 15px;
            box-shadow: 0 4px 8px rgba(78, 205, 196, 0.3);
          "
          onmouseover="this.style.backgroundColor='#26d0ce'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(78, 205, 196, 0.4)';"
          onmouseout="this.style.backgroundColor='#4ecdc4'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(78, 205, 196, 0.3)';"
        >
          ğŸ’‘ ë§¤ì¹­ ê²°ê³¼ ë³´ê¸°
        </button>
      </div>

      <!-- ë§¤ì¹­ ì§„í–‰ ìƒíƒœ í‘œì‹œ -->
      <div
        id="matching-progress"
        style="display: none; text-align: center; margin: 20px 0"
      >
        <div style="font-size: 1.2em; color: #5a3a22; margin-bottom: 10px">
          ğŸ”® AIê°€ ì‚¬ì£¼ì™€ MBTIë¥¼ ë¶„ì„í•˜ì—¬ ìµœì ì˜ ë§¤ì¹­ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...
        </div>
        <div
          style="
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff6b6b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
          "
        ></div>
      </div>

      <div class="search-bar">
        <input
          type="text"
          id="search-input"
          placeholder="ì´ë¦„ ë˜ëŠ” í•™ë²ˆìœ¼ë¡œ ê²€ìƒ‰..."
        />
      </div>

      {% if results %}
      <table class="results-table" id="results-table">
        <thead>
          <tr>
            <th>í•™ë²ˆ</th>
            <th>ì´ë¦„</th>
            <th>MBTI</th>
            <th>ì„±ë³„</th>
            <th>ì¸ìŠ¤íƒ€ê·¸ë¨</th>
            <th>ë§¤ì¹­ìƒíƒœ</th>
            <th>ë¶„ì„ì¼ì‹œ</th>
            <th>ì‘ì—…</th>
          </tr>
        </thead>
        <tbody>
          {% for result in results %}
          <tr>
            <td>{{ result.student_id }}</td>
            <td>{{ result.name }}</td>
            <td>{{ result.mbti }}</td>
            <td>{{ result.gender or '-' }}</td>
            <td>{{ result.instagram_id or '-' }}</td>
            <td>
              {% if result.is_matched %}
              <span style="color: #ff6b6b; font-weight: bold">âœ… ë§¤ì¹­ì™„ë£Œ</span>
              {% else %}
              <span style="color: #4ecdc4; font-weight: bold">â³ ëŒ€ê¸°ì¤‘</span>
              {% endif %}
            </td>
            <td>{{ result.created_at }}</td>
            <td>
              <button
                class="action-btn view-btn"
                onclick="viewResult({{ result.id }})"
              >
                ë³´ê¸°
              </button>
              <button
                class="action-btn delete-btn"
                onclick="deleteResult({{ result.id }})"
              >
                ì‚­ì œ
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="no-results">ğŸ“ ì•„ì§ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      {% endif %}
    </div>

    <!-- ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
    <div id="detail-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="result-detail" class="result-detail">
          <!-- AJAXë¡œ ë¡œë“œë  ë‚´ìš© -->
        </div>
      </div>
    </div>

    <!-- ë§¤ì¹­ ê²°ê³¼ ëª¨ë‹¬ -->
    <div id="matches-modal" class="modal">
      <div class="modal-content" style="max-width: 800px">
        <span class="close" onclick="closeMatchesModal()">&times;</span>
        <h2 style="color: #5a3a22; margin-bottom: 20px; text-align: center">
          ğŸ’‘ AI ë§¤ì¹­ ê²°ê³¼
        </h2>
        <div id="matches-content">
          <!-- AJAXë¡œ ë¡œë“œë  ë§¤ì¹­ ê²°ê³¼ -->
        </div>
      </div>
    </div>

    <script>
      // ê²€ìƒ‰ ê¸°ëŠ¥
      document
        .getElementById("search-input")
        .addEventListener("input", function () {
          const searchTerm = this.value.toLowerCase();
          const rows = document.querySelectorAll("#results-table tbody tr");

          rows.forEach((row) => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          });
        });

      // ê²°ê³¼ ìƒì„¸ë³´ê¸°
      async function viewResult(id) {
        try {
          const response = await fetch(`/admin/result/${id}`);
          const data = await response.json();

          if (response.ok) {
            document.getElementById("detail-modal").style.display = "block";

            document.getElementById("result-detail").innerHTML = `
                        <h3>ğŸ“‹ ë¶„ì„ ê²°ê³¼ ìƒì„¸ë³´ê¸°</h3>
                        <p><strong>í•™ë²ˆ:</strong> ${data.student_id}</p>
                        <p><strong>ì´ë¦„:</strong> ${data.name}</p>
                        <p><strong>MBTI:</strong> ${data.mbti}</p>
                        <p><strong>ì¸ìŠ¤íƒ€ê·¸ë¨:</strong> ${
                          data.instagram_id || "ì •ë³´ ì—†ìŒ"
                        }</p>
                        <p><strong>ë¶„ì„ì¼ì‹œ:</strong> ${data.created_at}</p>
                        <h4>ğŸ”® ì‚¬ì£¼ ì •ë³´</h4>
                        <p>${data.saju_result}</p>
                        <h4>ğŸ’¬ AI ë¶„ì„ ê²°ê³¼</h4>
                        <p style="white-space: pre-wrap; line-height: 1.6;">${
                          data.ai_analysis
                        }</p>
                    `;
          } else {
            alert("ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + data.error);
          }
        } catch (error) {
          alert("ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        }
      }

      // ê²°ê³¼ ì‚­ì œ
      async function deleteResult(id) {
        if (
          confirm(
            "ì •ë§ë¡œ ì´ ë¶„ì„ ê²°ê³¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          )
        ) {
          try {
            const response = await fetch(`/admin/result/${id}`, {
              method: "DELETE",
            });
            const data = await response.json();

            if (response.ok) {
              alert("ê²°ê³¼ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
              location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ëª©ë¡ ì—…ë°ì´íŠ¸
            } else {
              alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + data.error);
            }
          } catch (error) {
            alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
          }
        }
      }

      // ëª¨ë‹¬ ë‹«ê¸°
      function closeModal() {
        document.getElementById("detail-modal").style.display = "none";
      }

      // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
      window.onclick = function (event) {
        const modal = document.getElementById("detail-modal");
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };

      // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeModal();
        }
      });

      // ì˜¤ëŠ˜ì˜ ë¶„ì„ ìˆ˜ ê³„ì‚°
      function calculateTodayStats() {
        const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD í˜•ì‹
        const rows = document.querySelectorAll("#results-table tbody tr");
        let todayCount = 0;

        rows.forEach((row) => {
          const dateCell = row.cells[6]; // ë¶„ì„ì¼ì‹œ ì—´
          if (dateCell) {
            const resultDate = dateCell.textContent.split(" ")[0]; // ë‚ ì§œ ë¶€ë¶„ë§Œ ì¶”ì¶œ
            if (resultDate === today) {
              todayCount++;
            }
          }
        });

        document.getElementById("today-count").textContent = todayCount;
      }

      // API í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
      async function testAPI() {
        const btn = document.getElementById("api-test-btn");

        if (confirm("Gemini API ìƒíƒœë¥¼ í…ŒìŠ¤íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          btn.disabled = true;
          btn.textContent = "ğŸ”„ API í…ŒìŠ¤íŠ¸ ì¤‘...";

          try {
            const response = await fetch("/admin/api-test");
            const data = await response.json();

            if (response.ok) {
              let message = "ğŸ”§ API ìƒíƒœ í…ŒìŠ¤íŠ¸ ê²°ê³¼:\n\n";

              // API í‚¤ ìƒíƒœ
              message += `API í‚¤: ${
                data.api_key.valid ? "âœ… ìœ íš¨" : "âŒ ì˜¤ë¥˜"
              }\n`;
              message += `${data.api_key.message}\n\n`;

              // ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡
              if (data.available_models && data.available_models.length > 0) {
                message += `ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ë“¤ (${data.available_models.length}ê°œ):\n`;
                data.available_models.slice(0, 5).forEach((model) => {
                  message += `  - ${model}\n`;
                });
                if (data.available_models.length > 5) {
                  message += `  ... ì™¸ ${data.available_models.length - 5}ê°œ\n`;
                }
                message += "\n";
              }

              // ëª¨ë¸ ìƒíƒœ
              message += "í…ŒìŠ¤íŠ¸í•œ ëª¨ë¸ ìƒíƒœ:\n";
              for (const [modelName, modelInfo] of Object.entries(
                data.models
              )) {
                message += `${modelName}: ${
                  modelInfo.valid ? "âœ… ì‚¬ìš© ê°€ëŠ¥" : "âŒ ì‚¬ìš© ë¶ˆê°€"
                }\n`;
                message += `  ${modelInfo.message}\n`;
              }

              alert(message);
            } else {
              alert("API í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + data.error);
            }
          } catch (error) {
            alert("API í…ŒìŠ¤íŠ¸ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
          } finally {
            btn.disabled = false;
            btn.textContent = "ğŸ”§ API ìƒíƒœ í™•ì¸";
          }
        }
      }

      // ë§¤ì¹­ ì‹œì‘ í•¨ìˆ˜
      async function startMatching() {
        const btn = document.getElementById("matching-btn");
        const progressDiv = document.getElementById("matching-progress");

        if (
          confirm(
            "AI ë§¤ì¹­ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ì‚¬ìš©ì ìŒì— ëŒ€í•´ ì‚¬ì£¼ì™€ MBTI í˜¸í™˜ì„±ì„ ë¶„ì„í•©ë‹ˆë‹¤."
          )
        ) {
          // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ì§„í–‰ í‘œì‹œ
          btn.disabled = true;
          btn.textContent = "ğŸ”„ ë§¤ì¹­ ì§„í–‰ ì¤‘...";
          progressDiv.style.display = "block";

          try {
            const response = await fetch("/admin/matching", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            });

            const data = await response.json();

            if (response.ok) {
              alert(data.message);
              updateMatchesCount(); // ë§¤ì¹­ ê²°ê³¼ ìˆ˜ ì—…ë°ì´íŠ¸
            } else {
              alert("ë§¤ì¹­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + data.error);
            }
          } catch (error) {
            alert("ë§¤ì¹­ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
          } finally {
            // ë²„íŠ¼ ë³µì› ë° ì§„í–‰ í‘œì‹œ ìˆ¨ê¹€
            btn.disabled = false;
            btn.textContent = "ğŸ’• AI ë§¤ì¹­ ì‹œì‘í•˜ê¸°";
            progressDiv.style.display = "none";
          }
        }
      }

      // ë§¤ì¹­ ê²°ê³¼ ë³´ê¸° í•¨ìˆ˜
      async function viewMatches() {
        try {
          const response = await fetch("/admin/matching/results");
          const data = await response.json();

          if (response.ok) {
            displayMatches(data.matches);
          } else {
            alert("ë§¤ì¹­ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + data.error);
          }
        } catch (error) {
          alert(
            "ë§¤ì¹­ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message
          );
        }
      }

      // ë§¤ì¹­ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
      function displayMatches(matches) {
        const modal = document.getElementById("matches-modal");
        const content = document.getElementById("matches-content");

        if (matches.length === 0) {
          content.innerHTML =
            '<div style="text-align: center; padding: 40px; color: #666;">ğŸ’” ì•„ì§ ë§¤ì¹­ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € AI ë§¤ì¹­ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</div>';
        } else {
          let html = '<div style="max-height: 70vh; overflow-y: auto;">';

          matches.forEach((match, index) => {
            const scoreColor =
              match.compatibility_score >= 80
                ? "#ff6b6b"
                : match.compatibility_score >= 60
                ? "#ffa726"
                : match.compatibility_score >= 40
                ? "#4ecdc4"
                : "#666";

            html += `
              <div style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background-color: #fafafa;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <div style="font-size: 1.1em; font-weight: bold; color: #5a3a22;">
                    ${match.user1.name} ğŸ’• ${match.user2.name}
                  </div>
                  <div style="font-size: 1.2em; font-weight: bold; color: ${scoreColor};">
                    í˜¸í™˜ì„±: ${match.compatibility_score}ì 
                  </div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                  <div style="flex: 1;">
                    <strong>${match.user1.name}</strong> (${match.user1.mbti})
                    ${
                      match.user1.instagram
                        ? `<br><small>@${match.user1.instagram}</small>`
                        : ""
                    }
                  </div>
                  <div style="flex: 1; text-align: right;">
                    <strong>${match.user2.name}</strong> (${match.user2.mbti})
                    ${
                      match.user2.instagram
                        ? `<br><small>@${match.user2.instagram}</small>`
                        : ""
                    }
                  </div>
                </div>
                <div style="background-color: white; padding: 10px; border-radius: 4px; border-left: 3px solid ${scoreColor};">
                  <strong>ë§¤ì¹­ ë¶„ì„:</strong><br>
                  ${match.matching_reason}
                </div>
                <div style="text-align: right; margin-top: 5px;">
                  <small style="color: #666;">${match.created_at}</small>
                </div>
              </div>
            `;
          });

          html += "</div>";
          content.innerHTML = html;
        }

        modal.style.display = "block";
      }

      // ë§¤ì¹­ ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
      function closeMatchesModal() {
        document.getElementById("matches-modal").style.display = "none";
      }

      // ë§¤ì¹­ ê²°ê³¼ ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      async function updateMatchesCount() {
        try {
          const response = await fetch("/admin/matching/results");
          const data = await response.json();
          if (response.ok) {
            document.getElementById("matches-count").textContent =
              data.matches.length;
          }
        } catch (error) {
          console.error("ë§¤ì¹­ ìˆ˜ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:", error);
        }
      }

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      document
        .getElementById("api-test-btn")
        .addEventListener("click", testAPI);
      document
        .getElementById("matching-btn")
        .addEventListener("click", startMatching);
      document
        .getElementById("view-matches-btn")
        .addEventListener("click", viewMatches);

      // ë§¤ì¹­ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
      window.addEventListener("click", function (event) {
        const modal = document.getElementById("matches-modal");
        if (event.target == modal) {
          modal.style.display = "none";
        }
      });

      // ESC í‚¤ë¡œ ë§¤ì¹­ ëª¨ë‹¬ ë‹«ê¸°
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          const modal = document.getElementById("matches-modal");
          if (modal.style.display === "block") {
            modal.style.display = "none";
          }
        }
      });

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ëŠ˜ í†µê³„ ê³„ì‚° ë° ë§¤ì¹­ ìˆ˜ ì—…ë°ì´íŠ¸
      document.addEventListener("DOMContentLoaded", function () {
        calculateTodayStats();
        updateMatchesCount();
      });
    </script>
  </body>
</html>
