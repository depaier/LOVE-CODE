<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#ff69b4" />
    <meta name="description" content="AI 기반 사주 궁합 매칭 서비스" />
    <link rel="manifest" href="/static/manifest.json" />
    <!-- Favicon -->
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/static/img/LOVECODE_ICON.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/static/img/LOVECODE_ICON.png"
    />
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="/static/img/LOVECODE_ICON.png" />
    <title>LOVE-CODE - 사주 궁합 매칭</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=BM+Hanna+Pro&display=swap"
      rel="stylesheet"
    />

    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        50% {
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.7);
        }
        100% {
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
      }

      body {
        /* 2. font-family를 'BM Hanna Pro'로 변경 */
        font-family: "BM Hanna Pro", cursive;
        background-color: #fdfaf3;
        background-size: cover; /* 이미지가 화면 전체를 덮도록 설정 */
        background-position: center;
        background-attachment: fixed;
        color: #3a3a3a;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
      }
      .container {
        background-color: #ffffff;
        padding: 40px;
        border: 3px solid #8a6d59;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        width: 100%;
        max-width: 500px;
        text-align: center;
        animation: fadeIn 0.8s ease-out;
      }
      h1 {
        font-size: 3em; /* 폰트에 맞게 크기 살짝 조정 */
        color: #5a3a22;
        margin-bottom: 30px;
      }
      .form-group {
        margin-bottom: 25px;
        text-align: left;
      }
      label {
        display: block;
        margin-bottom: 8px;
        font-size: 1.5em; /* 폰트에 맞게 크기 살짝 조정 */
        color: #5a3a22;
      }
      input {
        width: 100%;
        padding: 10px;
        border: none;
        border-bottom: 2px solid #bda08c;
        border-radius: 0;
        background-color: transparent;
        font-size: 1.5em; /* 폰트에 맞게 크기 살짝 조정 */
        /* 2. 입력창 폰트도 변경 */
        font-family: "BM Hanna Pro", cursive;
        transition: border-color 0.3s;
      }
      input:focus {
        border-color: #a84448;
        outline: none;
        box-shadow: none;
      }

      select:focus {
        border-color: #a84448;
        outline: none;
        box-shadow: none;
      }
      button {
        width: 100%;
        padding: 15px;
        background-color: #a84448;
        color: #fdfaf3;
        border: none;
        border-radius: 4px;
        font-size: 1.8em; /* 폰트에 맞게 크기 살짝 조정 */
        /* 2. 버튼 폰트도 변경 */
        font-family: "BM Hanna Pro", cursive;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #8c383b;
      }
      button.disabled-notification {
        background-color: #ccc !important;
        cursor: not-allowed !important;
        opacity: 0.6;
      }
      button.disabled-notification:hover {
        background-color: #ccc !important;
      }

      /* 체크박스 스타일 */
      .checkbox-group {
        text-align: left;
        margin-bottom: 20px;
      }

      .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 1.3em;
        color: #5a3a22;
        position: relative;
        padding-left: 35px;
        line-height: 0.8;
        min-height: 24px;
        height: 34px;
      }

      .checkbox-label input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
      }

      .checkmark {
        position: absolute;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        height: 20px;
        width: 20px;
        background-color: #ffffff;
        border: 2px solid #bda08c;
        border-radius: 3px;
        transition: all 0.3s;
      }

      .checkbox-label input[type="checkbox"]:checked ~ .checkmark {
        background-color: #a84448;
        border-color: #a84448;
      }

      .checkmark:after {
        content: "";
        position: absolute;
        display: none;
        left: 50%;
        top: 50%;
        width: 6px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: translate(-50%, -60%) rotate(45deg);
        transform-origin: center;
      }

      .checkbox-label input[type="checkbox"]:checked ~ .checkmark:after {
        display: block;
      }

      .privacy-link {
        color: #a84448;
        text-decoration: none;
        font-weight: bold;
        transition: color 0.3s;
        margin: 0 4px;
      }

      .privacy-link:hover {
        color: #8c383b;
        text-decoration: underline;
      }

      /* 체크박스 필수 표시 */
      .checkbox-label::after {
        content: " *";
        color: #a84448;
        font-weight: bold;
        margin-left: 2px;
      }

      /* 테스트 버튼 스타일 주석처리 */
      /*
      #test-modal-btn:hover {
        background-color: #555 !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      */
      /* 모달 관련 스타일 */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s ease-out;
      }
      .modal-content {
        background-color: #ffffff;
        margin: 5% auto;
        padding: 20px;
        border: 3px solid #8a6d59;
        border-radius: 8px;
        width: calc(100% - 20px);
        max-width: 600px;
        max-height: 85vh;
        overflow-y: auto;
        animation: fadeIn 0.5s ease-out;
        position: relative;
      }
      .close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 2em;
        font-weight: bold;
        cursor: pointer;
        color: #5a3a22;
        transition: all 0.3s;
        z-index: 1001;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #8a6d59;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        -webkit-tap-highlight-color: transparent;
      }
      .close:hover,
      .close:active {
        color: #a84448;
        background: rgba(168, 68, 72, 0.1);
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      .loading-message {
        text-align: center;
        color: #5a3a22;
        font-size: 1.3em;
        margin: 20px 0;
        display: none;
      }
      .loading-message.visible {
        display: block;
      }
      #result-text {
        white-space: pre-wrap;
        line-height: 1.8;
        font-size: 1.4em;
        color: #3a3a3a;
        margin-top: 20px;
        display: none;
      }
      #result-text.visible {
        display: block;
      }
      #loader {
        display: none;
        margin: 20px auto;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #a84448;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }

      /* 모바일 반응형 스타일 */
      @media (max-width: 768px) {
        .modal-content {
          margin: 1% auto;
          padding: 15px;
          width: calc(100vw - 40px);
          max-width: 550px;
          max-height: 95vh;
        }
        .close {
          top: 8px;
          right: 12px;
          font-size: 1.8em;
          width: 45px;
          height: 45px;
          border: 2px solid #8a6d59;
        }
        #result-text {
          font-size: 1.2em;
        }
        .loading-message {
          font-size: 1.1em;
        }
      }

      @media (max-width: 480px) {
        .modal-content {
          margin: 0.5% auto;
          padding: 12px;
          width: calc(100vw - 32px);
          max-width: 400px;
          max-height: 96vh;
          border-radius: 6px;
        }
        .close {
          top: 5px;
          right: 8px;
          font-size: 2em;
          width: 48px;
          height: 48px;
          border: 2px solid #8a6d59;
          background: rgba(255, 255, 255, 0.95);
        }
        #result-text {
          font-size: 1.1em;
          margin-top: 15px;
          line-height: 1.6;
        }
        .loading-message {
          font-size: 1em;
          margin: 15px 0;
        }
        .checkbox-label {
          font-size: 1em;
          padding-left: 30px;
          min-height: 20px;
        }
        .checkmark {
          height: 18px;
          width: 18px;
        }
        .checkmark:after {
          left: 50%;
          top: 50%;
          width: 5px;
          height: 9px;
          transform: translate(-50%, -60%) rotate(45deg);
          transform-origin: center;
        }
      }

      /* 작은 모바일 기기 (320px 이하) */
      @media (max-width: 320px) {
        .modal-content {
          margin: 0.3% auto;
          padding: 10px;
          width: calc(100vw - 24px);
          max-width: 280px;
          max-height: 97vh;
          border-radius: 4px;
        }
        .close {
          top: 3px;
          right: 5px;
          font-size: 2.2em;
          width: 50px;
          height: 50px;
          background: rgba(255, 255, 255, 1);
          border: 3px solid #8a6d59;
          box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        #result-text {
          font-size: 1em;
          margin-top: 12px;
          line-height: 1.5;
        }
        .loading-message {
          font-size: 0.95em;
          margin: 12px 0;
        }
        .checkbox-label {
          font-size: 0.9em;
          padding-left: 28px;
          min-height: 18px;
        }
        .checkmark {
          height: 16px;
          width: 16px;
        }
        .checkmark:after {
          left: 50%;
          top: 50%;
          width: 4px;
          height: 7px;
          transform: translate(-50%, -60%) rotate(45deg);
          transform-origin: center;
        }
      }

      /* 터치 디바이스 최적화 */
      @media (hover: none) and (pointer: coarse) {
        .modal-content {
          width: calc(100vw - 28px);
          max-width: 450px;
          max-height: 95vh;
        }
        .close {
          width: 48px;
          height: 48px;
          font-size: 2.2em;
          background: rgba(255, 255, 255, 1);
          border: 3px solid #8a6d59;
        }
        .close:active {
          transform: scale(0.95);
          background: rgba(168, 68, 72, 0.15);
        }
        #result-text {
          line-height: 1.6;
          -webkit-touch-callout: none;
          -webkit-user-select: none;
          -khtml-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
        }
        .checkmark {
          height: 24px;
          width: 24px;
        }
        .checkbox-label {
          padding-left: 32px;
          min-height: 26px;
          font-size: 0.85em;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>LOVE-CODE</h1>

      <!-- 테스트 버튼 주석처리
      <div style="text-align: center; margin-bottom: 20px">
        <button
          type="button"
          id="test-modal-btn"
          style="
            background-color: #666;
            color: #fff;
            border: 2px solid #8a6d59;
            border-radius: 6px;
            padding: 10px 20px;
            font-size: 1em;
            font-family: 'BM Hanna Pro', cursive;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          "
        >
          🎯 테스트 모달 보기
        </button>
      </div>
      -->

      <!-- 사주 분석 완료 후 버튼들 (사주 분석 완료 후에만 표시) -->
      <div
        id="my-results-section"
        style="
          margin-bottom: 20px;
          display: none;
          flex-direction: column;
          align-items: center;
          gap: 15px;
        "
      >
        <button
          type="button"
          id="my-saju-btn"
          style="
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            font-size: 1.3em;
            font-family: 'BM Hanna Pro', cursive;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
            width: 100%;
            max-width: 300px;
          "
          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(78, 205, 196, 0.4)'"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(78, 205, 196, 0.3)'"
        >
          🔮 내 사주 결과 보기
        </button>

        <button
          type="button"
          id="my-matches-btn"
          style="
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            font-size: 1.3em;
            font-family: 'BM Hanna Pro', cursive;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            width: 100%;
            max-width: 300px;
          "
          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 107, 107, 0.4)'"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255, 107, 107, 0.3)'"
        >
          💕 내 매칭 결과 보기
        </button>

        <div
          id="user-info"
          style="
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
            font-weight: bold;
            text-align: center;
          "
        ></div>
      </div>

      <!-- 푸시 알림 설정 버튼 -->
      <div style="text-align: center; margin-bottom: 30px">
        <button
          type="button"
          id="push-settings-btn"
          style="
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            font-size: 1.2em;
            font-family: 'BM Hanna Pro', cursive;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
          "
        >
          🔔 푸시 알림 설정
        </button>
        <div
          id="push-status"
          style="margin-top: 10px; font-size: 0.9em; color: #666"
        ></div>
        <div id="home-screen-prompt" style="display: none; margin-top: 10px">
          <small class="text-muted d-block">
            📱 iOS Safari에서 푸시 알림을 사용하려면 공유 - 홈 화면에 추가
            해주세요
          </small>
        </div>
      </div>

      <form id="saju-form">
        <div class="form-group">
          <label for="name">이름</label
          ><input
            type="text"
            id="name"
            inputmode="korean"
            lang="ko"
            autocorrect="off"
            autocapitalize="off"
            autocomplete="name"
            required
            placeholder="예: 홍길동"
          />
        </div>
        <div class="form-group">
          <label for="studentId">학번</label
          ><input
            type="number"
            id="studentId"
            inputmode="numeric"
            pattern="[0-9]*"
            required
            placeholder="예: 20240001"
          />
        </div>
        <div class="form-group">
          <label for="birthdate">생년월일</label
          ><input type="date" id="birthdate" required value="2000-01-01" />
        </div>
        <div class="form-group">
          <label for="hour">태어난 시 (時)</label
          ><input
            type="number"
            id="hour"
            inputmode="numeric"
            pattern="[0-9]*"
            required
            placeholder="0~23 사이 숫자"
          />
        </div>
        <div class="form-group">
          <label for="mbti">MBTI</label
          ><input
            type="text"
            id="mbti"
            required
            placeholder="예: ENFP"
            maxlength="4"
            pattern="[A-Z]{4}"
            inputmode="latin"
            style="text-transform: uppercase; ime-mode: disabled"
            oninput="this.value = this.value.toUpperCase().replace(/[^A-Z]/g, '').substring(0, 4)"
          />
        </div>
        <div class="form-group">
          <label for="gender">성별</label>
          <select
            id="gender"
            required
            style="
              width: 100%;
              padding: 10px;
              border: none;
              border-bottom: 2px solid #bda08c;
              border-radius: 0;
              background-color: transparent;
              font-size: 1.5em;
              font-family: 'BM Hanna Pro', cursive;
              transition: border-color 0.3s;
              color: #3a3a3a;
            "
          >
            <option value="">선택해주세요</option>
            <option value="MALE">남성</option>
            <option value="FEMALE">여성</option>
          </select>
        </div>
        <div class="form-group">
          <label for="instagramId"
            >인스타그램 아이디
            <!-- <span style="color: #a84448; font-weight: bold">*</span> -->
          </label>
          <input
            type="text"
            id="instagramId"
            inputmode="latin"
            style="ime-mode: disabled"
            required
            placeholder="예: my_instagram"
            oninput="this.value = this.value.replace(/[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/g, '')"
            autocapitalize="off"
          />
        </div>

        <!-- 개인정보 동의 체크박스 -->
        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="privacyConsent" required />
            <span class="checkmark"></span>
            <a
              href="https://stealth-panther-e75.notion.site/LOVE-CODE-2732cfa1c19a801aa39fc751c2bbd923?source=copy_link"
              target="_blank"
              rel="noopener noreferrer"
              class="privacy-link"
            >
              개인정보 처리방침 </a
            >에 동의합니다
          </label>
        </div>

        <button type="submit">결과 보기</button>
      </form>
    </div>

    <!-- 사주 분석 모달 창 -->
    <div id="result-modal" class="modal">
      <div class="modal-content">
        <span class="close" title="닫기">&times;</span>
        <h2 style="color: #5a3a22; margin-bottom: 20px; text-align: center">
          사주 분석 결과
        </h2>
        <div class="loading-message" id="loading-message">
          🔮 사주를 분석하고 있습니다...
        </div>
        <div id="loader"></div>
        <div id="result-text"></div>
      </div>
    </div>

    <!-- 내 사주 결과 모달 창 -->
    <div id="my-saju-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeMySajuModal()" title="닫기"
          >&times;</span
        >
        <h2 style="color: #5a3a22; margin-bottom: 20px; text-align: center">
          🔮 내 사주 분석 결과
        </h2>
        <div id="my-saju-content"></div>
      </div>
    </div>
    <script>
      const sajuForm = document.getElementById("saju-form");
      // const testBtn = document.getElementById("test-modal-btn"); // 테스트 버튼 주석처리
      const modal = document.getElementById("result-modal");
      const loader = document.getElementById("loader");
      const resultText = document.getElementById("result-text");
      const loadingMessage = document.getElementById("loading-message");
      const closeBtn = document.getElementsByClassName("close")[0];

      // 로딩 상태 추적 변수
      let isLoading = false;

      // 모달창 열기 함수
      function openModal() {
        modal.style.display = "block";
        document.body.style.overflow = "hidden"; // 배경 스크롤 방지
      }

      // 모달창 닫기 함수
      function closeModal() {
        modal.style.display = "none";
        document.body.style.overflow = "auto"; // 배경 스크롤 복원
        resultText.textContent = "";
        resultText.classList.remove("visible");
        loadingMessage.classList.remove("visible");
        loader.style.display = "none";
        isLoading = false; // 로딩 상태 초기화
      }

      // 내 사주 모달 닫기 함수
      function closeMySajuModal() {
        const mySajuModal = document.getElementById("my-saju-modal");
        mySajuModal.style.display = "none";
        document.body.style.overflow = "auto"; // 배경 스크롤 복원
      }

      // 테스트 모달 열기 함수 주석처리
      /*
      function openTestModal() {
        openModal();
        showResult(
          "🎯 테스트 모달입니다!\n\n이 모달창은 실제 사주 분석 없이\nUI/UX를 테스트하기 위한 용도입니다.\n\n닫기 버튼과 ESC 키로 닫을 수 있습니다."
        );
      }
      */

      // 로딩 상태 표시 함수
      function showLoading() {
        isLoading = true; // 로딩 시작
        loadingMessage.classList.add("visible");
        loader.style.display = "block";
        resultText.classList.remove("visible");
      }

      // 로딩 완료 후 결과 표시 함수
      function showResult(result) {
        isLoading = false; // 로딩 완료
        loadingMessage.classList.remove("visible");
        loader.style.display = "none";
        resultText.textContent = result;
        resultText.classList.add("visible");
      }

      // 테스트 버튼 클릭 이벤트 주석처리
      /*
      testBtn.onclick = function () {
        openTestModal();
      };
      */

      // 닫기 버튼 클릭 이벤트 (모바일 터치 지원)
      closeBtn.onclick = function () {
        // 로딩 중에는 닫기 버튼도 비활성화
        if (!isLoading) {
          closeModal();
        }
      };

      // 모바일 터치 이벤트 지원
      closeBtn.addEventListener(
        "touchstart",
        function (e) {
          // 로딩 중에는 터치 이벤트도 무시
          if (isLoading) {
            return;
          }
          e.preventDefault();
          closeModal();
        },
        { passive: false }
      );

      // 모달 외부 클릭 시 닫기 (터치 지원)
      function handleModalClose(event) {
        // 로딩 중에는 모달 바깥 클릭으로 닫을 수 없음
        if (isLoading) {
          return;
        }
        if (event.target == modal) {
          closeModal();
        }

        // 내 사주 모달 닫기
        const mySajuModal = document.getElementById("my-saju-modal");
        if (event.target == mySajuModal) {
          closeMySajuModal();
        }
      }

      window.onclick = handleModalClose;
      window.addEventListener("touchend", handleModalClose, { passive: true });

      // ESC 키로 모달 닫기
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          // 사주 분석 모달 닫기 (로딩 중이 아닐 때만)
          if (modal.style.display === "block" && !isLoading) {
            closeModal();
          }

          // 내 사주 모달 닫기
          const mySajuModal = document.getElementById("my-saju-modal");
          if (mySajuModal.style.display === "block") {
            closeMySajuModal();
          }
        }
      });

      // 푸시 알림 관리 클래스
      class PushNotificationManager {
        constructor() {
          this.deviceToken = localStorage.getItem("deviceToken");
          this.userId = null;
          this.registration = null;
          this.vapidPublicKey = null;
          this.init();
          this.updateStatusDisplay();
        }

        async init() {
          // Service Worker 지원 확인
          if ("serviceWorker" in navigator && "PushManager" in window) {
            try {
              // Service Worker 등록
              this.registration = await navigator.serviceWorker.register(
                "/static/js/sw.js"
              );
              console.log("Service Worker 등록 성공");

              // VAPID 퍼블릭 키 가져오기
              await this.loadVapidPublicKey();

              // 기존 디바이스 토큰이 없으면 생성
              if (!this.deviceToken) {
                await this.createDeviceToken();
              }
            } catch (error) {
              console.error("푸시 알림 초기화 실패:", error);
            }
          }

          this.updateStatusDisplay();
        }

        updateStatusDisplay() {
          const statusEl = document.getElementById("push-status");
          const homeScreenPrompt =
            document.getElementById("home-screen-prompt");
          if (!statusEl) return;

          let status = "준비 중...";
          let color = "#666";

          // iOS Safari 감지
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const isSafari = /^((?!chrome|android).)*safari/i.test(
            navigator.userAgent
          );

          // PWA 모드 확인 (Home Screen에서 실행 중인지)
          const isPWA = window.navigator.standalone === true;

          // Home Screen 프롬프트 표시 여부
          if (homeScreenPrompt) {
            homeScreenPrompt.style.display =
              !isPWA && isIOS && isSafari ? "block" : "none";
          }

          if (!("serviceWorker" in navigator) || !("PushManager" in window)) {
            if (isIOS && isSafari) {
              if (isPWA) {
                status = "✅ PWA 모드에서 실행 중입니다.";
                color = "#28a745";
              } else {
                status =
                  "⚠️ iOS Safari에서는 iOS 16.4 이상에서 푸시 알림을 지원합니다.";
                color = "#ffc107";
              }
            } else {
              status = "❌ 이 브라우저는 푸시 알림을 지원하지 않습니다.";
              color = "#dc3545";
            }
          } else if (
            location.protocol !== "https:" &&
            location.hostname !== "localhost"
          ) {
            status = "⚠️ HTTPS 연결이 필요합니다 (또는 localhost에서만 작동).";
            color = "#ffc107";
          } else if (!isPWA && isIOS && isSafari) {
            status =
              "📱 먼저 '홈 화면에 추가'를 해야 푸시 알림을 사용할 수 있습니다.";
            color = "#ff6b35";
          } else if (Notification.permission === "granted") {
            // 푸시 알림이 이미 허용되었으면 버튼과 상태 메시지 모두 숨기기
            const pushButton = document.getElementById("push-settings-btn");
            if (pushButton) {
              pushButton.style.display = "none";
            }
            if (statusEl) {
              statusEl.style.display = "none";
            }
            return; // 상태 업데이트 생략
          } else if (Notification.permission === "denied") {
            status = "❌ 푸시 알림 권한이 차단되었습니다.";
            color = "#dc3545";
          } else {
            if (isIOS && isSafari) {
              status =
                "🔔 iOS Safari에서 푸시 알림을 설정하려면 버튼을 클릭하세요.";
            } else {
              status = "🔔 푸시 알림 권한을 설정하려면 버튼을 클릭하세요.";
            }
            color = "#007bff";
          }

          statusEl.innerHTML = status;
          statusEl.style.color = color;
        }

        // Home Screen 추가 안내 함수
        showAddToHomeScreen() {
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const isSafari = /^((?!chrome|android).)*safari/i.test(
            navigator.userAgent
          );

          if (isIOS && isSafari) {
            alert(`📱 iOS Safari에서 홈 화면에 추가하는 방법:

1. Safari 브라우저 하단의 공유 버튼(□)을 탭하세요
2. "홈 화면에 추가"를 선택하세요
3. "추가" 버튼을 눌러 홈 화면에 추가하세요

추가 후 홈 화면에서 앱을 실행하면 푸시 알림을 사용할 수 있습니다!`);
          } else {
            alert("이 기능은 iOS Safari에서만 필요합니다.");
          }
        }

        // andreinwald 예제처럼 VAPID 공개 키를 직접 설정
        async loadVapidPublicKey() {
          // 환경변수나 설정에서 가져온 VAPID 공개 키
          this.vapidPublicKey =
            "BHfpLCcwKDVg2TkshpmVn9Tr3nizK-dxkCAkAIIkp59UBXRU3Iwim8FuSCXoQOLUYjPxO6GJPncPup_bBpK7z-w";
          console.log("VAPID 공개 키 설정됨:", this.vapidPublicKey);
        }

        async createDeviceToken() {
          try {
            const response = await fetch("/api/user/device-token", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            });
            const data = await response.json();
            this.deviceToken = data.device_token;
            localStorage.setItem("deviceToken", this.deviceToken);
            console.log("디바이스 토큰 생성:", this.deviceToken);
          } catch (error) {
            console.error("디바이스 토큰 생성 실패:", error);
          }
        }

        async requestNotificationPermission() {
          // iOS Safari 감지
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const isSafari = /^((?!chrome|android).)*safari/i.test(
            navigator.userAgent
          );

          if (!("Notification" in window)) {
            if (isIOS && isSafari) {
              alert(
                "iOS Safari에서는 iOS 16.4 이상에서 푸시 알림을 지원합니다."
              );
            } else {
              alert("이 브라우저는 푸시 알림을 지원하지 않습니다.");
            }
            this.updateStatusDisplay();
            return false;
          }

          // HTTPS 또는 localhost 확인
          if (
            location.protocol !== "https:" &&
            location.hostname !== "localhost"
          ) {
            alert(
              "푸시 알림은 HTTPS 연결에서만 작동합니다.\n(또는 localhost에서 테스트 가능)"
            );
            this.updateStatusDisplay();
            return false;
          }

          try {
            const permission = await Notification.requestPermission();
            this.updateStatusDisplay();

            if (permission === "granted") {
              if (isIOS && isSafari) {
                console.log("iOS Safari에서 푸시 알림 권한이 허용되었습니다.");
              }
            } else if (permission === "denied") {
              if (isIOS && isSafari) {
                // 권한 거부 시 홈화면 추가 안내
                alert(
                  "📱 iOS Safari에서 푸시 알림을 사용하려면 홈 화면에 추가가 필요합니다.\n\nSafari 하단 공유 버튼 → 홈 화면에 추가"
                );
              }
            }

            return permission === "granted";
          } catch (error) {
            console.error("알림 권한 요청 실패:", error);
            this.updateStatusDisplay();
            return false;
          }
        }

        async subscribeToPush() {
          if (!this.registration || !this.vapidPublicKey) {
            console.error("푸시 구독을 위한 준비가 되지 않았습니다.");
            return false;
          }

          try {
            const subscription = await this.registration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: this.urlBase64ToUint8Array(
                this.vapidPublicKey
              ),
            });

            // 서버에 구독 정보 전송
            const response = await fetch("/api/push/subscribe", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                device_token: this.deviceToken,
                subscription: {
                  endpoint: subscription.endpoint,
                  keys: {
                    p256dh: this.arrayBufferToBase64(
                      subscription.getKey("p256dh")
                    ),
                    auth: this.arrayBufferToBase64(subscription.getKey("auth")),
                  },
                },
                user_id: this.userId, // 사주 분석 완료 후 연결
              }),
            });

            if (response.ok) {
              console.log("푸시 알림 구독 성공");
              return true;
            } else {
              console.error("푸시 구독 서버 등록 실패");
              return false;
            }
          } catch (error) {
            console.error("푸시 구독 실패:", error);
            return false;
          }
        }

        async linkDeviceToUser(userId) {
          this.userId = userId;
          try {
            const response = await fetch("/api/user/link-device", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                device_token: this.deviceToken,
                user_id: userId,
              }),
            });

            if (response.ok) {
              console.log("디바이스가 사용자 계정에 연결되었습니다.");
            } else {
              console.error("디바이스 연결 실패");
            }
          } catch (error) {
            console.error("디바이스 연결 중 오류:", error);
          }
        }

        urlBase64ToUint8Array(base64String) {
          const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
          const base64 = (base64String + padding)
            .replace(/-/g, "+")
            .replace(/_/g, "/");

          const rawData = window.atob(base64);
          const outputArray = new Uint8Array(rawData.length);

          for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
          }
          return outputArray;
        }

        arrayBufferToBase64(buffer) {
          const bytes = new Uint8Array(buffer);
          let binary = "";
          for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
          }
          return window.btoa(binary);
        }
      }

      // 푸시 알림 관리자 인스턴스 생성
      const pushManager = new PushNotificationManager();

      // 사용자 정보 관리 클래스
      class UserManager {
        constructor() {
          this.loadUserInfo();
          this.updateMyResultsSection();
        }

        loadUserInfo() {
          const userData = localStorage.getItem("userData");
          if (userData) {
            try {
              this.userInfo = JSON.parse(userData);
            } catch (error) {
              console.error("사용자 정보 로드 실패:", error);
              this.userInfo = null;
            }
          } else {
            this.userInfo = null;
          }
        }

        saveUserInfo(userData) {
          this.userInfo = userData;
          localStorage.setItem("userData", JSON.stringify(userData));
          this.updateMyResultsSection();
        }

        updateMyResultsSection() {
          const section = document.getElementById("my-results-section");
          const userInfoDiv = document.getElementById("user-info");
          const matchesButton = document.getElementById("my-matches-btn");
          const sajuButton = document.getElementById("my-saju-btn");

          if (this.userInfo && this.userInfo.user_id) {
            section.style.display = "flex";
            userInfoDiv.textContent = `${this.userInfo.name}님 (학번: ${this.userInfo.studentId})`;

            // 매칭 결과 버튼 클릭 이벤트
            matchesButton.onclick = () => {
              window.location.href = `/matches/${this.userInfo.user_id}`;
            };

            // 사주 결과 버튼 클릭 이벤트
            sajuButton.onclick = () => {
              this.showMySajuResult();
            };
          } else {
            section.style.display = "none";
          }
        }

        showMySajuResult() {
          if (this.userInfo && this.userInfo.ai_analysis) {
            const modal = document.getElementById("my-saju-modal");
            const content = document.getElementById("my-saju-content");

            content.innerHTML = `
              <div style="background-color: #fdfaf3; border: 2px solid #bda08c; border-radius: 4px; padding: 20px; line-height: 1.8; font-size: 1.4em; color: #3a3a3a; white-space: pre-wrap;">
                ${this.userInfo.ai_analysis}
              </div>
            `;

            modal.style.display = "block";
            document.body.style.overflow = "hidden"; // 배경 스크롤 방지
          } else {
            alert("저장된 사주 분석 결과가 없습니다.");
          }
        }

        clearUserInfo() {
          this.userInfo = null;
          localStorage.removeItem("userData");
          this.updateMyResultsSection();
        }
      }

      // 사용자 관리자 인스턴스 생성
      const userManager = new UserManager();

      // 알림 권한 체크 및 폼 필드 가이드 함수
      function checkNotificationAndGuide() {
        if (Notification.permission !== "granted") {
          alert(
            "🔔 매칭 알림을 받기 위해 먼저 푸시 알림을 허용해주세요!\n\n위의 '푸시 알림 설정' 버튼을 클릭하여 알림을 허용한 후 정보를 입력해주세요."
          );

          // 푸시 설정 버튼으로 스크롤
          const pushButton = document.getElementById("push-settings-btn");
          if (pushButton && pushButton.style.display !== "none") {
            pushButton.scrollIntoView({ behavior: "smooth", block: "center" });
            // 버튼 강조 효과
            pushButton.style.animation = "pulse 1s ease-in-out 3";
            pushButton.style.transform = "scale(1.05)";
            setTimeout(() => {
              pushButton.style.animation = "";
              pushButton.style.transform = "";
            }, 3000);
          }
          return false;
        }
        return true;
      }

      // 알림 권한 상태에 따라 폼 UI 업데이트
      function updateFormUIBasedOnNotification() {
        const submitButton = document.querySelector(
          '#saju-form button[type="submit"]'
        );

        if (Notification.permission !== "granted") {
          if (submitButton) {
            submitButton.classList.add("disabled-notification");
            submitButton.textContent = "🔔 먼저 알림을 허용해주세요";
          }
        } else {
          if (submitButton) {
            submitButton.classList.remove("disabled-notification");
            submitButton.textContent = "결과 보기";
          }
        }
      }

      // 모든 입력 필드에 이벤트 리스너 추가
      document.addEventListener("DOMContentLoaded", function () {
        // 페이지 로드 시 폼 UI 상태 업데이트
        updateFormUIBasedOnNotification();

        const formInputs = document.querySelectorAll(
          '#saju-form input:not([type="checkbox"]), #saju-form select'
        );

        formInputs.forEach((input) => {
          input.addEventListener("focus", function () {
            if (Notification.permission !== "granted") {
              this.blur(); // 포커스 제거
              checkNotificationAndGuide();
            }
          });
        });

        // 개인정보 동의 체크박스에 대한 별도 처리
        const privacyCheckbox = document.getElementById("privacyConsent");
        if (privacyCheckbox) {
          privacyCheckbox.addEventListener("click", function (e) {
            if (Notification.permission !== "granted") {
              e.preventDefault(); // 체크 방지
              checkNotificationAndGuide();
            }
          });
        }
      });

      // 푸시 설정 버튼 이벤트
      document
        .getElementById("push-settings-btn")
        .addEventListener("click", async () => {
          const button = document.getElementById("push-settings-btn");
          button.disabled = true;
          button.innerHTML = "⏳ 설정 중...";

          // iOS Safari 감지
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const isSafari = /^((?!chrome|android).)*safari/i.test(
            navigator.userAgent
          );

          try {
            const permissionGranted =
              await pushManager.requestNotificationPermission();

            if (permissionGranted) {
              const subscribed = await pushManager.subscribeToPush();
              if (subscribed) {
                alert(
                  "✅ 푸시 알림이 성공적으로 설정되었습니다!\n매칭이 완료되면 알림을 보내드립니다.\n\n이제 아래 정보를 입력하여 사주 분석을 받아보세요!"
                );
                // 푸시 알림 설정이 완료되면 버튼과 상태 메시지 숨기기
                document.getElementById("push-settings-btn").style.display =
                  "none";
                document.getElementById("push-status").style.display = "none";

                // 폼 UI 업데이트 (버튼 활성화)
                updateFormUIBasedOnNotification();
              } else {
                alert(
                  "푸시 알림 구독에 실패했습니다.\n잠시 후 다시 시도해주세요."
                );
              }
            } else {
              // requestNotificationPermission()에서 이미 alert 표시했으므로 여기서는 표시하지 않음
              console.log("푸시 알림 권한이 거부되었습니다.");
            }
          } catch (error) {
            console.error("푸시 설정 실패:", error);
            alert("푸시 알림 설정 중 오류가 발생했습니다.");
          } finally {
            button.disabled = false;
            button.innerHTML = "🔔 푸시 알림 설정";
          }
        });

      sajuForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        // 알림 권한 확인 - 가장 먼저 체크
        if (Notification.permission !== "granted") {
          alert(
            "🔔 매칭 알림을 받기 위해 먼저 푸시 알림을 허용해주세요!\n\n위의 '푸시 알림 설정' 버튼을 클릭하여 알림을 허용한 후 다시 시도해주세요."
          );
          // 푸시 설정 버튼으로 스크롤
          const pushButton = document.getElementById("push-settings-btn");
          if (pushButton && pushButton.style.display !== "none") {
            pushButton.scrollIntoView({ behavior: "smooth", block: "center" });
            // 버튼 강조 효과
            pushButton.style.animation = "pulse 1s ease-in-out 3";
            pushButton.style.transform = "scale(1.05)";
            setTimeout(() => {
              pushButton.style.animation = "";
              pushButton.style.transform = "";
            }, 3000);
          }
          return;
        }

        // 성별 선택 확인
        const gender = document.getElementById("gender").value;
        if (!gender) {
          alert("성별을 선택해주세요.");
          document.getElementById("gender").focus();
          return;
        }

        // 인스타그램 아이디 유효성 검사
        const instagramId = document.getElementById("instagramId").value.trim();
        if (!instagramId) {
          alert("인스타그램 아이디를 입력해주세요.");
          document.getElementById("instagramId").focus();
          return;
        }

        // 인스타그램 아이디 형식 검사 (@ 없이 입력해야 함)
        if (instagramId.startsWith("@")) {
          alert(
            "인스타그램 아이디 앞에 @를 붙이지 말고 입력해주세요.\n예: my_instagram"
          );
          document.getElementById("instagramId").focus();
          return;
        }

        // 개인정보 동의 체크 확인
        const privacyConsent = document.getElementById("privacyConsent");
        if (!privacyConsent.checked) {
          alert("개인정보 처리방침에 동의해주세요.");
          privacyConsent.focus();
          return;
        }

        // 모달 열기 및 로딩 상태 표시
        openModal();
        showLoading();

        const birthdate = document.getElementById("birthdate").value;
        const birthDateObj = new Date(birthdate);
        const data = {
          name: document.getElementById("name").value,
          studentId: document.getElementById("studentId").value,
          year: birthDateObj.getFullYear(),
          month: birthDateObj.getMonth() + 1, // getMonth()는 0부터 시작하므로 +1
          day: birthDateObj.getDate(),
          hour: parseInt(document.getElementById("hour").value),
          mbti: document.getElementById("mbti").value.toUpperCase(),
          gender: document.getElementById("gender").value,
          instagramId: document.getElementById("instagramId").value,
        };

        try {
          const response = await fetch("/saju", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          const result = await response.json();
          if (response.ok) {
            showResult(result.ai_analysis);

            // 사용자 ID가 있으면 디바이스 연결 및 사용자 정보 저장
            if (result.user_id) {
              await pushManager.linkDeviceToUser(result.user_id);

              // 사용자 정보를 로컬 스토리지에 저장
              const userData = {
                user_id: result.user_id,
                name: data.name,
                studentId: data.studentId,
                mbti: data.mbti,
                gender: data.gender,
                ai_analysis: result.ai_analysis,
              };
              userManager.saveUserInfo(userData);
            }
          } else {
            showResult("오류가 발생했습니다: " + result.error);
          }
        } catch (error) {
          showResult(
            "서버와 통신하는 데 실패했습니다. 서버가 켜져 있는지 확인해주세요."
          );
        }
      });

      // Service Worker 메시지 수신 처리 (알림 클릭 시 페이지 이동)
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.addEventListener("message", function (event) {
          console.log("📨 Service Worker 메시지 수신:", event.data);

          if (event.data && event.data.type === "NAVIGATE" && event.data.url) {
            console.log(
              `🔄 페이지 이동 요청: ${window.location.href} → ${event.data.url}`
            );

            try {
              // 강제 페이지 이동
              console.log("🚀 페이지 이동 실행 중...");
              window.location.href = event.data.url;

              // 혹시 위가 안 되면 replace도 시도
              setTimeout(() => {
                console.log("🔄 window.location.replace 시도");
                window.location.replace(event.data.url);
              }, 100);
            } catch (err) {
              console.error("❌ 페이지 이동 실패:", err);
              // 최후의 수단: 새 창 열기
              try {
                window.open(event.data.url, "_blank");
                console.log("🆕 새 창으로 열기 시도");
              } catch (openErr) {
                console.error("❌ 새 창 열기도 실패:", openErr);
              }
            }
          }
        });

        // 메시지 수신 확인을 위한 추가 이벤트
        navigator.serviceWorker.ready.then((registration) => {
          console.log("🔧 Service Worker 준비 완료, 메시지 수신 대기 중");
        });
      }

      // 페이지 로드 시 URL 파라미터 확인 (알림에서 홈으로 온 경우)
      document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const notification = urlParams.get("notification");

        if (notification === "waiting") {
          // 매칭 대기 중 알림에서 온 경우
          setTimeout(() => {
            alert(
              "⏳ 아직 매칭이 진행 중입니다.\n매칭이 완료되면 알림을 보내드릴게요!"
            );
          }, 500);
        } else if (notification === "missing_user_id") {
          // user_id가 없어서 매칭 페이지로 이동할 수 없는 경우
          setTimeout(() => {
            alert(
              "⚠️ 매칭 알림을 클릭하셨지만 사용자 정보를 찾을 수 없습니다.\n먼저 사주 분석을 완료해주세요!"
            );
          }, 500);
        }
      });
    </script>
  </body>
</html>
