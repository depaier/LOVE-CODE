<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#ff69b4" />
    <meta name="description" content="AI ê¸°ë°˜ ì‚¬ì£¼ ê¶í•© ë§¤ì¹­ ì„œë¹„ìŠ¤" />
    <link rel="manifest" href="/static/manifest.json" />
    <!-- Favicon -->
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/static/img/LOVECODE_ICON.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/static/img/LOVECODE_ICON.png"
    />
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="/static/img/LOVECODE_ICON.png" />
    <title>LOVE-CODE - ì‚¬ì£¼ ê¶í•© ë§¤ì¹­</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=BM+Hanna+Pro&display=swap"
      rel="stylesheet"
    />

    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        50% {
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.7);
        }
        100% {
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
      }

      body {
        /* 2. font-familyë¥¼ 'BM Hanna Pro'ë¡œ ë³€ê²½ */
        font-family: "BM Hanna Pro", cursive;
        background-color: #fdfaf3;
        background-size: cover; /* ì´ë¯¸ì§€ê°€ í™”ë©´ ì „ì²´ë¥¼ ë®ë„ë¡ ì„¤ì • */
        background-position: center;
        background-attachment: fixed;
        color: #3a3a3a;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
      }
      .container {
        background-color: #ffffff;
        padding: 40px;
        border: 3px solid #8a6d59;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        width: 100%;
        max-width: 500px;
        text-align: center;
        animation: fadeIn 0.8s ease-out;
      }
      h1 {
        font-size: 3em; /* í°íŠ¸ì— ë§ê²Œ í¬ê¸° ì‚´ì§ ì¡°ì • */
        color: #5a3a22;
        margin-bottom: 30px;
      }
      .form-group {
        margin-bottom: 25px;
        text-align: left;
      }
      label {
        display: block;
        margin-bottom: 8px;
        font-size: 1.5em; /* í°íŠ¸ì— ë§ê²Œ í¬ê¸° ì‚´ì§ ì¡°ì • */
        color: #5a3a22;
      }
      input {
        width: 100%;
        padding: 10px;
        border: none;
        border-bottom: 2px solid #bda08c;
        border-radius: 0;
        background-color: transparent;
        font-size: 1.5em; /* í°íŠ¸ì— ë§ê²Œ í¬ê¸° ì‚´ì§ ì¡°ì • */
        /* 2. ì…ë ¥ì°½ í°íŠ¸ë„ ë³€ê²½ */
        font-family: "BM Hanna Pro", cursive;
        transition: border-color 0.3s;
      }
      input:focus {
        border-color: #a84448;
        outline: none;
        box-shadow: none;
      }

      select:focus {
        border-color: #a84448;
        outline: none;
        box-shadow: none;
      }
      button {
        width: 100%;
        padding: 15px;
        background-color: #a84448;
        color: #fdfaf3;
        border: none;
        border-radius: 4px;
        font-size: 1.8em; /* í°íŠ¸ì— ë§ê²Œ í¬ê¸° ì‚´ì§ ì¡°ì • */
        /* 2. ë²„íŠ¼ í°íŠ¸ë„ ë³€ê²½ */
        font-family: "BM Hanna Pro", cursive;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #8c383b;
      }
      button.disabled-notification {
        background-color: #ccc !important;
        cursor: not-allowed !important;
        opacity: 0.6;
      }
      button.disabled-notification:hover {
        background-color: #ccc !important;
      }

      /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
      .checkbox-group {
        text-align: left;
        margin-bottom: 20px;
      }

      .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 1.3em;
        color: #5a3a22;
        position: relative;
        padding-left: 35px;
        line-height: 0.8;
        min-height: 24px;
        height: 34px;
      }

      .checkbox-label input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
      }

      .checkmark {
        position: absolute;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        height: 20px;
        width: 20px;
        background-color: #ffffff;
        border: 2px solid #bda08c;
        border-radius: 3px;
        transition: all 0.3s;
      }

      .checkbox-label input[type="checkbox"]:checked ~ .checkmark {
        background-color: #a84448;
        border-color: #a84448;
      }

      .checkmark:after {
        content: "";
        position: absolute;
        display: none;
        left: 50%;
        top: 50%;
        width: 6px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: translate(-50%, -60%) rotate(45deg);
        transform-origin: center;
      }

      .checkbox-label input[type="checkbox"]:checked ~ .checkmark:after {
        display: block;
      }

      .privacy-link {
        color: #a84448;
        text-decoration: none;
        font-weight: bold;
        transition: color 0.3s;
        margin: 0 4px;
      }

      .privacy-link:hover {
        color: #8c383b;
        text-decoration: underline;
      }

      /* ì²´í¬ë°•ìŠ¤ í•„ìˆ˜ í‘œì‹œ */
      .checkbox-label::after {
        content: " *";
        color: #a84448;
        font-weight: bold;
        margin-left: 2px;
      }

      /* í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì£¼ì„ì²˜ë¦¬ */
      /*
      #test-modal-btn:hover {
        background-color: #555 !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      */
      /* ëª¨ë‹¬ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s ease-out;
      }
      .modal-content {
        background-color: #ffffff;
        margin: 5% auto;
        padding: 20px;
        border: 3px solid #8a6d59;
        border-radius: 8px;
        width: calc(100% - 20px);
        max-width: 600px;
        max-height: 85vh;
        overflow-y: auto;
        animation: fadeIn 0.5s ease-out;
        position: relative;
      }
      .close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 2em;
        font-weight: bold;
        cursor: pointer;
        color: #5a3a22;
        transition: all 0.3s;
        z-index: 1001;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #8a6d59;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        -webkit-tap-highlight-color: transparent;
      }
      .close:hover,
      .close:active {
        color: #a84448;
        background: rgba(168, 68, 72, 0.1);
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      .loading-message {
        text-align: center;
        color: #5a3a22;
        font-size: 1.3em;
        margin: 20px 0;
        display: none;
      }
      .loading-message.visible {
        display: block;
      }
      #result-text {
        white-space: pre-wrap;
        line-height: 1.8;
        font-size: 1.4em;
        color: #3a3a3a;
        margin-top: 20px;
        display: none;
      }
      #result-text.visible {
        display: block;
      }
      #loader {
        display: none;
        margin: 20px auto;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #a84448;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }

      /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
      @media (max-width: 768px) {
        .modal-content {
          margin: 1% auto;
          padding: 15px;
          width: calc(100vw - 40px);
          max-width: 550px;
          max-height: 95vh;
        }
        .close {
          top: 8px;
          right: 12px;
          font-size: 1.8em;
          width: 45px;
          height: 45px;
          border: 2px solid #8a6d59;
        }
        #result-text {
          font-size: 1.2em;
        }
        .loading-message {
          font-size: 1.1em;
        }
      }

      @media (max-width: 480px) {
        .modal-content {
          margin: 0.5% auto;
          padding: 12px;
          width: calc(100vw - 32px);
          max-width: 400px;
          max-height: 96vh;
          border-radius: 6px;
        }
        .close {
          top: 5px;
          right: 8px;
          font-size: 2em;
          width: 48px;
          height: 48px;
          border: 2px solid #8a6d59;
          background: rgba(255, 255, 255, 0.95);
        }
        #result-text {
          font-size: 1.1em;
          margin-top: 15px;
          line-height: 1.6;
        }
        .loading-message {
          font-size: 1em;
          margin: 15px 0;
        }
        .checkbox-label {
          font-size: 1em;
          padding-left: 30px;
          min-height: 20px;
        }
        .checkmark {
          height: 18px;
          width: 18px;
        }
        .checkmark:after {
          left: 50%;
          top: 50%;
          width: 5px;
          height: 9px;
          transform: translate(-50%, -60%) rotate(45deg);
          transform-origin: center;
        }
      }

      /* ì‘ì€ ëª¨ë°”ì¼ ê¸°ê¸° (320px ì´í•˜) */
      @media (max-width: 320px) {
        .modal-content {
          margin: 0.3% auto;
          padding: 10px;
          width: calc(100vw - 24px);
          max-width: 280px;
          max-height: 97vh;
          border-radius: 4px;
        }
        .close {
          top: 3px;
          right: 5px;
          font-size: 2.2em;
          width: 50px;
          height: 50px;
          background: rgba(255, 255, 255, 1);
          border: 3px solid #8a6d59;
          box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        #result-text {
          font-size: 1em;
          margin-top: 12px;
          line-height: 1.5;
        }
        .loading-message {
          font-size: 0.95em;
          margin: 12px 0;
        }
        .checkbox-label {
          font-size: 0.9em;
          padding-left: 28px;
          min-height: 18px;
        }
        .checkmark {
          height: 16px;
          width: 16px;
        }
        .checkmark:after {
          left: 50%;
          top: 50%;
          width: 4px;
          height: 7px;
          transform: translate(-50%, -60%) rotate(45deg);
          transform-origin: center;
        }
      }

      /* í„°ì¹˜ ë””ë°”ì´ìŠ¤ ìµœì í™” */
      @media (hover: none) and (pointer: coarse) {
        .modal-content {
          width: calc(100vw - 28px);
          max-width: 450px;
          max-height: 95vh;
        }
        .close {
          width: 48px;
          height: 48px;
          font-size: 2.2em;
          background: rgba(255, 255, 255, 1);
          border: 3px solid #8a6d59;
        }
        .close:active {
          transform: scale(0.95);
          background: rgba(168, 68, 72, 0.15);
        }
        #result-text {
          line-height: 1.6;
          -webkit-touch-callout: none;
          -webkit-user-select: none;
          -khtml-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
        }
        .checkmark {
          height: 24px;
          width: 24px;
        }
        .checkbox-label {
          padding-left: 32px;
          min-height: 26px;
          font-size: 0.85em;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>LOVE-CODE</h1>

      <!-- í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì£¼ì„ì²˜ë¦¬
      <div style="text-align: center; margin-bottom: 20px">
        <button
          type="button"
          id="test-modal-btn"
          style="
            background-color: #666;
            color: #fff;
            border: 2px solid #8a6d59;
            border-radius: 6px;
            padding: 10px 20px;
            font-size: 1em;
            font-family: 'BM Hanna Pro', cursive;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          "
        >
          ğŸ¯ í…ŒìŠ¤íŠ¸ ëª¨ë‹¬ ë³´ê¸°
        </button>
      </div>
      -->

      <!-- ì‚¬ì£¼ ë¶„ì„ ì™„ë£Œ í›„ ë²„íŠ¼ë“¤ (ì‚¬ì£¼ ë¶„ì„ ì™„ë£Œ í›„ì—ë§Œ í‘œì‹œ) -->
      <div
        id="my-results-section"
        style="
          margin-bottom: 20px;
          display: none;
          flex-direction: column;
          align-items: center;
          gap: 15px;
        "
      >
        <button
          type="button"
          id="my-saju-btn"
          style="
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            font-size: 1.3em;
            font-family: 'BM Hanna Pro', cursive;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
            width: 100%;
            max-width: 300px;
          "
          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(78, 205, 196, 0.4)'"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(78, 205, 196, 0.3)'"
        >
          ğŸ”® ë‚´ ì‚¬ì£¼ ê²°ê³¼ ë³´ê¸°
        </button>

        <button
          type="button"
          id="my-matches-btn"
          style="
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            font-size: 1.3em;
            font-family: 'BM Hanna Pro', cursive;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            width: 100%;
            max-width: 300px;
          "
          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 107, 107, 0.4)'"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255, 107, 107, 0.3)'"
        >
          ğŸ’• ë‚´ ë§¤ì¹­ ê²°ê³¼ ë³´ê¸°
        </button>

        <div
          id="user-info"
          style="
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
            font-weight: bold;
            text-align: center;
          "
        ></div>
      </div>

      <!-- í‘¸ì‹œ ì•Œë¦¼ ì„¤ì • ë²„íŠ¼ -->
      <div style="text-align: center; margin-bottom: 30px">
        <button
          type="button"
          id="push-settings-btn"
          style="
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            font-size: 1.2em;
            font-family: 'BM Hanna Pro', cursive;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
          "
        >
          ğŸ”” í‘¸ì‹œ ì•Œë¦¼ ì„¤ì •
        </button>
        <div
          id="push-status"
          style="margin-top: 10px; font-size: 0.9em; color: #666"
        ></div>
        <div id="home-screen-prompt" style="display: none; margin-top: 10px">
          <small class="text-muted d-block">
            ğŸ“± iOS Safariì—ì„œ í‘¸ì‹œ ì•Œë¦¼ì„ ì‚¬ìš©í•˜ë ¤ë©´ ê³µìœ  - í™ˆ í™”ë©´ì— ì¶”ê°€
            í•´ì£¼ì„¸ìš”
          </small>
        </div>
      </div>

      <form id="saju-form">
        <div class="form-group">
          <label for="name">ì´ë¦„</label
          ><input
            type="text"
            id="name"
            inputmode="korean"
            lang="ko"
            autocorrect="off"
            autocapitalize="off"
            autocomplete="name"
            required
            placeholder="ì˜ˆ: í™ê¸¸ë™"
          />
        </div>
        <div class="form-group">
          <label for="studentId">í•™ë²ˆ</label
          ><input
            type="number"
            id="studentId"
            inputmode="numeric"
            pattern="[0-9]*"
            required
            placeholder="ì˜ˆ: 20240001"
          />
        </div>
        <div class="form-group">
          <label for="birthdate">ìƒë…„ì›”ì¼</label
          ><input type="date" id="birthdate" required value="2000-01-01" />
        </div>
        <div class="form-group">
          <label for="hour">íƒœì–´ë‚œ ì‹œ (æ™‚)</label
          ><input
            type="number"
            id="hour"
            inputmode="numeric"
            pattern="[0-9]*"
            required
            placeholder="0~23 ì‚¬ì´ ìˆ«ì"
          />
        </div>
        <div class="form-group">
          <label for="mbti">MBTI</label
          ><input
            type="text"
            id="mbti"
            required
            placeholder="ì˜ˆ: ENFP"
            maxlength="4"
            pattern="[A-Z]{4}"
            inputmode="latin"
            style="text-transform: uppercase; ime-mode: disabled"
            oninput="this.value = this.value.toUpperCase().replace(/[^A-Z]/g, '').substring(0, 4)"
          />
        </div>
        <div class="form-group">
          <label for="gender">ì„±ë³„</label>
          <select
            id="gender"
            required
            style="
              width: 100%;
              padding: 10px;
              border: none;
              border-bottom: 2px solid #bda08c;
              border-radius: 0;
              background-color: transparent;
              font-size: 1.5em;
              font-family: 'BM Hanna Pro', cursive;
              transition: border-color 0.3s;
              color: #3a3a3a;
            "
          >
            <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
            <option value="MALE">ë‚¨ì„±</option>
            <option value="FEMALE">ì—¬ì„±</option>
          </select>
        </div>
        <div class="form-group">
          <label for="instagramId"
            >ì¸ìŠ¤íƒ€ê·¸ë¨ ì•„ì´ë””
            <!-- <span style="color: #a84448; font-weight: bold">*</span> -->
          </label>
          <input
            type="text"
            id="instagramId"
            inputmode="latin"
            style="ime-mode: disabled"
            required
            placeholder="ì˜ˆ: my_instagram"
            oninput="this.value = this.value.replace(/[ã„±-ã…|ã…-ã…£|ê°€-í£]/g, '')"
            autocapitalize="off"
          />
        </div>

        <!-- ê°œì¸ì •ë³´ ë™ì˜ ì²´í¬ë°•ìŠ¤ -->
        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="privacyConsent" required />
            <span class="checkmark"></span>
            <a
              href="https://stealth-panther-e75.notion.site/LOVE-CODE-2732cfa1c19a801aa39fc751c2bbd923?source=copy_link"
              target="_blank"
              rel="noopener noreferrer"
              class="privacy-link"
            >
              ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ </a
            >ì— ë™ì˜í•©ë‹ˆë‹¤
          </label>
        </div>

        <button type="submit">ê²°ê³¼ ë³´ê¸°</button>
      </form>
    </div>

    <!-- ì‚¬ì£¼ ë¶„ì„ ëª¨ë‹¬ ì°½ -->
    <div id="result-modal" class="modal">
      <div class="modal-content">
        <span class="close" title="ë‹«ê¸°">&times;</span>
        <h2 style="color: #5a3a22; margin-bottom: 20px; text-align: center">
          ì‚¬ì£¼ ë¶„ì„ ê²°ê³¼
        </h2>
        <div class="loading-message" id="loading-message">
          ğŸ”® ì‚¬ì£¼ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...
        </div>
        <div id="loader"></div>
        <div id="result-text"></div>
      </div>
    </div>

    <!-- ë‚´ ì‚¬ì£¼ ê²°ê³¼ ëª¨ë‹¬ ì°½ -->
    <div id="my-saju-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeMySajuModal()" title="ë‹«ê¸°"
          >&times;</span
        >
        <h2 style="color: #5a3a22; margin-bottom: 20px; text-align: center">
          ğŸ”® ë‚´ ì‚¬ì£¼ ë¶„ì„ ê²°ê³¼
        </h2>
        <div id="my-saju-content"></div>
      </div>
    </div>
    <script>
      const sajuForm = document.getElementById("saju-form");
      // const testBtn = document.getElementById("test-modal-btn"); // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì£¼ì„ì²˜ë¦¬
      const modal = document.getElementById("result-modal");
      const loader = document.getElementById("loader");
      const resultText = document.getElementById("result-text");
      const loadingMessage = document.getElementById("loading-message");
      const closeBtn = document.getElementsByClassName("close")[0];

      // ë¡œë”© ìƒíƒœ ì¶”ì  ë³€ìˆ˜
      let isLoading = false;

      // ëª¨ë‹¬ì°½ ì—´ê¸° í•¨ìˆ˜
      function openModal() {
        modal.style.display = "block";
        document.body.style.overflow = "hidden"; // ë°°ê²½ ìŠ¤í¬ë¡¤ ë°©ì§€
      }

      // ëª¨ë‹¬ì°½ ë‹«ê¸° í•¨ìˆ˜
      function closeModal() {
        modal.style.display = "none";
        document.body.style.overflow = "auto"; // ë°°ê²½ ìŠ¤í¬ë¡¤ ë³µì›
        resultText.textContent = "";
        resultText.classList.remove("visible");
        loadingMessage.classList.remove("visible");
        loader.style.display = "none";
        isLoading = false; // ë¡œë”© ìƒíƒœ ì´ˆê¸°í™”
      }

      // ë‚´ ì‚¬ì£¼ ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
      function closeMySajuModal() {
        const mySajuModal = document.getElementById("my-saju-modal");
        mySajuModal.style.display = "none";
        document.body.style.overflow = "auto"; // ë°°ê²½ ìŠ¤í¬ë¡¤ ë³µì›
      }

      // í…ŒìŠ¤íŠ¸ ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜ ì£¼ì„ì²˜ë¦¬
      /*
      function openTestModal() {
        openModal();
        showResult(
          "ğŸ¯ í…ŒìŠ¤íŠ¸ ëª¨ë‹¬ì…ë‹ˆë‹¤!\n\nì´ ëª¨ë‹¬ì°½ì€ ì‹¤ì œ ì‚¬ì£¼ ë¶„ì„ ì—†ì´\nUI/UXë¥¼ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•œ ìš©ë„ì…ë‹ˆë‹¤.\n\në‹«ê¸° ë²„íŠ¼ê³¼ ESC í‚¤ë¡œ ë‹«ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        );
      }
      */

      // ë¡œë”© ìƒíƒœ í‘œì‹œ í•¨ìˆ˜
      function showLoading() {
        isLoading = true; // ë¡œë”© ì‹œì‘
        loadingMessage.classList.add("visible");
        loader.style.display = "block";
        resultText.classList.remove("visible");
      }

      // ë¡œë”© ì™„ë£Œ í›„ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
      function showResult(result) {
        isLoading = false; // ë¡œë”© ì™„ë£Œ
        loadingMessage.classList.remove("visible");
        loader.style.display = "none";
        resultText.textContent = result;
        resultText.classList.add("visible");
      }

      // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì£¼ì„ì²˜ë¦¬
      /*
      testBtn.onclick = function () {
        openTestModal();
      };
      */

      // ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼ í„°ì¹˜ ì§€ì›)
      closeBtn.onclick = function () {
        // ë¡œë”© ì¤‘ì—ëŠ” ë‹«ê¸° ë²„íŠ¼ë„ ë¹„í™œì„±í™”
        if (!isLoading) {
          closeModal();
        }
      };

      // ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸ ì§€ì›
      closeBtn.addEventListener(
        "touchstart",
        function (e) {
          // ë¡œë”© ì¤‘ì—ëŠ” í„°ì¹˜ ì´ë²¤íŠ¸ë„ ë¬´ì‹œ
          if (isLoading) {
            return;
          }
          e.preventDefault();
          closeModal();
        },
        { passive: false }
      );

      // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° (í„°ì¹˜ ì§€ì›)
      function handleModalClose(event) {
        // ë¡œë”© ì¤‘ì—ëŠ” ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ìœ¼ë¡œ ë‹«ì„ ìˆ˜ ì—†ìŒ
        if (isLoading) {
          return;
        }
        if (event.target == modal) {
          closeModal();
        }

        // ë‚´ ì‚¬ì£¼ ëª¨ë‹¬ ë‹«ê¸°
        const mySajuModal = document.getElementById("my-saju-modal");
        if (event.target == mySajuModal) {
          closeMySajuModal();
        }
      }

      window.onclick = handleModalClose;
      window.addEventListener("touchend", handleModalClose, { passive: true });

      // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          // ì‚¬ì£¼ ë¶„ì„ ëª¨ë‹¬ ë‹«ê¸° (ë¡œë”© ì¤‘ì´ ì•„ë‹ ë•Œë§Œ)
          if (modal.style.display === "block" && !isLoading) {
            closeModal();
          }

          // ë‚´ ì‚¬ì£¼ ëª¨ë‹¬ ë‹«ê¸°
          const mySajuModal = document.getElementById("my-saju-modal");
          if (mySajuModal.style.display === "block") {
            closeMySajuModal();
          }
        }
      });

      // í‘¸ì‹œ ì•Œë¦¼ ê´€ë¦¬ í´ë˜ìŠ¤
      class PushNotificationManager {
        constructor() {
          this.deviceToken = localStorage.getItem("deviceToken");
          this.userId = null;
          this.registration = null;
          this.vapidPublicKey = null;
          this.init();
          this.updateStatusDisplay();
        }

        async init() {
          // Service Worker ì§€ì› í™•ì¸
          if ("serviceWorker" in navigator && "PushManager" in window) {
            try {
              // Service Worker ë“±ë¡
              this.registration = await navigator.serviceWorker.register(
                "/static/js/sw.js"
              );
              console.log("Service Worker ë“±ë¡ ì„±ê³µ");

              // VAPID í¼ë¸”ë¦­ í‚¤ ê°€ì ¸ì˜¤ê¸°
              await this.loadVapidPublicKey();

              // ê¸°ì¡´ ë””ë°”ì´ìŠ¤ í† í°ì´ ì—†ìœ¼ë©´ ìƒì„±
              if (!this.deviceToken) {
                await this.createDeviceToken();
              }
            } catch (error) {
              console.error("í‘¸ì‹œ ì•Œë¦¼ ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
            }
          }

          this.updateStatusDisplay();
        }

        updateStatusDisplay() {
          const statusEl = document.getElementById("push-status");
          const homeScreenPrompt =
            document.getElementById("home-screen-prompt");
          if (!statusEl) return;

          let status = "ì¤€ë¹„ ì¤‘...";
          let color = "#666";

          // iOS Safari ê°ì§€
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const isSafari = /^((?!chrome|android).)*safari/i.test(
            navigator.userAgent
          );

          // PWA ëª¨ë“œ í™•ì¸ (Home Screenì—ì„œ ì‹¤í–‰ ì¤‘ì¸ì§€)
          const isPWA = window.navigator.standalone === true;

          // Home Screen í”„ë¡¬í”„íŠ¸ í‘œì‹œ ì—¬ë¶€
          if (homeScreenPrompt) {
            homeScreenPrompt.style.display =
              !isPWA && isIOS && isSafari ? "block" : "none";
          }

          if (!("serviceWorker" in navigator) || !("PushManager" in window)) {
            if (isIOS && isSafari) {
              if (isPWA) {
                status = "âœ… PWA ëª¨ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.";
                color = "#28a745";
              } else {
                status =
                  "âš ï¸ iOS Safariì—ì„œëŠ” iOS 16.4 ì´ìƒì—ì„œ í‘¸ì‹œ ì•Œë¦¼ì„ ì§€ì›í•©ë‹ˆë‹¤.";
                color = "#ffc107";
              }
            } else {
              status = "âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” í‘¸ì‹œ ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
              color = "#dc3545";
            }
          } else if (
            location.protocol !== "https:" &&
            location.hostname !== "localhost"
          ) {
            status = "âš ï¸ HTTPS ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤ (ë˜ëŠ” localhostì—ì„œë§Œ ì‘ë™).";
            color = "#ffc107";
          } else if (!isPWA && isIOS && isSafari) {
            status =
              "ğŸ“± ë¨¼ì € 'í™ˆ í™”ë©´ì— ì¶”ê°€'ë¥¼ í•´ì•¼ í‘¸ì‹œ ì•Œë¦¼ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
            color = "#ff6b35";
          } else if (Notification.permission === "granted") {
            // í‘¸ì‹œ ì•Œë¦¼ì´ ì´ë¯¸ í—ˆìš©ë˜ì—ˆìœ¼ë©´ ë²„íŠ¼ê³¼ ìƒíƒœ ë©”ì‹œì§€ ëª¨ë‘ ìˆ¨ê¸°ê¸°
            const pushButton = document.getElementById("push-settings-btn");
            if (pushButton) {
              pushButton.style.display = "none";
            }
            if (statusEl) {
              statusEl.style.display = "none";
            }
            return; // ìƒíƒœ ì—…ë°ì´íŠ¸ ìƒëµ
          } else if (Notification.permission === "denied") {
            status = "âŒ í‘¸ì‹œ ì•Œë¦¼ ê¶Œí•œì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.";
            color = "#dc3545";
          } else {
            if (isIOS && isSafari) {
              status =
                "ğŸ”” iOS Safariì—ì„œ í‘¸ì‹œ ì•Œë¦¼ì„ ì„¤ì •í•˜ë ¤ë©´ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.";
            } else {
              status = "ğŸ”” í‘¸ì‹œ ì•Œë¦¼ ê¶Œí•œì„ ì„¤ì •í•˜ë ¤ë©´ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.";
            }
            color = "#007bff";
          }

          statusEl.innerHTML = status;
          statusEl.style.color = color;
        }

        // Home Screen ì¶”ê°€ ì•ˆë‚´ í•¨ìˆ˜
        showAddToHomeScreen() {
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const isSafari = /^((?!chrome|android).)*safari/i.test(
            navigator.userAgent
          );

          if (isIOS && isSafari) {
            alert(`ğŸ“± iOS Safariì—ì„œ í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ëŠ” ë°©ë²•:

1. Safari ë¸Œë¼ìš°ì € í•˜ë‹¨ì˜ ê³µìœ  ë²„íŠ¼(â–¡)ì„ íƒ­í•˜ì„¸ìš”
2. "í™ˆ í™”ë©´ì— ì¶”ê°€"ë¥¼ ì„ íƒí•˜ì„¸ìš”
3. "ì¶”ê°€" ë²„íŠ¼ì„ ëˆŒëŸ¬ í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ì„¸ìš”

ì¶”ê°€ í›„ í™ˆ í™”ë©´ì—ì„œ ì•±ì„ ì‹¤í–‰í•˜ë©´ í‘¸ì‹œ ì•Œë¦¼ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!`);
          } else {
            alert("ì´ ê¸°ëŠ¥ì€ iOS Safariì—ì„œë§Œ í•„ìš”í•©ë‹ˆë‹¤.");
          }
        }

        // andreinwald ì˜ˆì œì²˜ëŸ¼ VAPID ê³µê°œ í‚¤ë¥¼ ì§ì ‘ ì„¤ì •
        async loadVapidPublicKey() {
          // í™˜ê²½ë³€ìˆ˜ë‚˜ ì„¤ì •ì—ì„œ ê°€ì ¸ì˜¨ VAPID ê³µê°œ í‚¤
          this.vapidPublicKey =
            "BHfpLCcwKDVg2TkshpmVn9Tr3nizK-dxkCAkAIIkp59UBXRU3Iwim8FuSCXoQOLUYjPxO6GJPncPup_bBpK7z-w";
          console.log("VAPID ê³µê°œ í‚¤ ì„¤ì •ë¨:", this.vapidPublicKey);
        }

        async createDeviceToken() {
          try {
            const response = await fetch("/api/user/device-token", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            });
            const data = await response.json();
            this.deviceToken = data.device_token;
            localStorage.setItem("deviceToken", this.deviceToken);
            console.log("ë””ë°”ì´ìŠ¤ í† í° ìƒì„±:", this.deviceToken);
          } catch (error) {
            console.error("ë””ë°”ì´ìŠ¤ í† í° ìƒì„± ì‹¤íŒ¨:", error);
          }
        }

        async requestNotificationPermission() {
          // iOS Safari ê°ì§€
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const isSafari = /^((?!chrome|android).)*safari/i.test(
            navigator.userAgent
          );

          if (!("Notification" in window)) {
            if (isIOS && isSafari) {
              alert(
                "iOS Safariì—ì„œëŠ” iOS 16.4 ì´ìƒì—ì„œ í‘¸ì‹œ ì•Œë¦¼ì„ ì§€ì›í•©ë‹ˆë‹¤."
              );
            } else {
              alert("ì´ ë¸Œë¼ìš°ì €ëŠ” í‘¸ì‹œ ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
            this.updateStatusDisplay();
            return false;
          }

          // HTTPS ë˜ëŠ” localhost í™•ì¸
          if (
            location.protocol !== "https:" &&
            location.hostname !== "localhost"
          ) {
            alert(
              "í‘¸ì‹œ ì•Œë¦¼ì€ HTTPS ì—°ê²°ì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤.\n(ë˜ëŠ” localhostì—ì„œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥)"
            );
            this.updateStatusDisplay();
            return false;
          }

          try {
            const permission = await Notification.requestPermission();
            this.updateStatusDisplay();

            if (permission === "granted") {
              if (isIOS && isSafari) {
                console.log("iOS Safariì—ì„œ í‘¸ì‹œ ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
              }
            } else if (permission === "denied") {
              if (isIOS && isSafari) {
                // ê¶Œí•œ ê±°ë¶€ ì‹œ í™ˆí™”ë©´ ì¶”ê°€ ì•ˆë‚´
                alert(
                  "ğŸ“± iOS Safariì—ì„œ í‘¸ì‹œ ì•Œë¦¼ì„ ì‚¬ìš©í•˜ë ¤ë©´ í™ˆ í™”ë©´ì— ì¶”ê°€ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n\nSafari í•˜ë‹¨ ê³µìœ  ë²„íŠ¼ â†’ í™ˆ í™”ë©´ì— ì¶”ê°€"
                );
              }
            }

            return permission === "granted";
          } catch (error) {
            console.error("ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:", error);
            this.updateStatusDisplay();
            return false;
          }
        }

        async subscribeToPush() {
          if (!this.registration || !this.vapidPublicKey) {
            console.error("í‘¸ì‹œ êµ¬ë…ì„ ìœ„í•œ ì¤€ë¹„ê°€ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return false;
          }

          try {
            const subscription = await this.registration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: this.urlBase64ToUint8Array(
                this.vapidPublicKey
              ),
            });

            // ì„œë²„ì— êµ¬ë… ì •ë³´ ì „ì†¡
            const response = await fetch("/api/push/subscribe", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                device_token: this.deviceToken,
                subscription: {
                  endpoint: subscription.endpoint,
                  keys: {
                    p256dh: this.arrayBufferToBase64(
                      subscription.getKey("p256dh")
                    ),
                    auth: this.arrayBufferToBase64(subscription.getKey("auth")),
                  },
                },
                user_id: this.userId, // ì‚¬ì£¼ ë¶„ì„ ì™„ë£Œ í›„ ì—°ê²°
              }),
            });

            if (response.ok) {
              console.log("í‘¸ì‹œ ì•Œë¦¼ êµ¬ë… ì„±ê³µ");
              return true;
            } else {
              console.error("í‘¸ì‹œ êµ¬ë… ì„œë²„ ë“±ë¡ ì‹¤íŒ¨");
              return false;
            }
          } catch (error) {
            console.error("í‘¸ì‹œ êµ¬ë… ì‹¤íŒ¨:", error);
            return false;
          }
        }

        async linkDeviceToUser(userId) {
          this.userId = userId;
          try {
            const response = await fetch("/api/user/link-device", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                device_token: this.deviceToken,
                user_id: userId,
              }),
            });

            if (response.ok) {
              console.log("ë””ë°”ì´ìŠ¤ê°€ ì‚¬ìš©ì ê³„ì •ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
              console.error("ë””ë°”ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨");
            }
          } catch (error) {
            console.error("ë””ë°”ì´ìŠ¤ ì—°ê²° ì¤‘ ì˜¤ë¥˜:", error);
          }
        }

        urlBase64ToUint8Array(base64String) {
          const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
          const base64 = (base64String + padding)
            .replace(/-/g, "+")
            .replace(/_/g, "/");

          const rawData = window.atob(base64);
          const outputArray = new Uint8Array(rawData.length);

          for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
          }
          return outputArray;
        }

        arrayBufferToBase64(buffer) {
          const bytes = new Uint8Array(buffer);
          let binary = "";
          for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
          }
          return window.btoa(binary);
        }
      }

      // í‘¸ì‹œ ì•Œë¦¼ ê´€ë¦¬ì ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
      const pushManager = new PushNotificationManager();

      // ì‚¬ìš©ì ì •ë³´ ê´€ë¦¬ í´ë˜ìŠ¤
      class UserManager {
        constructor() {
          this.loadUserInfo();
          this.updateMyResultsSection();
        }

        loadUserInfo() {
          const userData = localStorage.getItem("userData");
          if (userData) {
            try {
              this.userInfo = JSON.parse(userData);
            } catch (error) {
              console.error("ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:", error);
              this.userInfo = null;
            }
          } else {
            this.userInfo = null;
          }
        }

        saveUserInfo(userData) {
          this.userInfo = userData;
          localStorage.setItem("userData", JSON.stringify(userData));
          this.updateMyResultsSection();
        }

        updateMyResultsSection() {
          const section = document.getElementById("my-results-section");
          const userInfoDiv = document.getElementById("user-info");
          const matchesButton = document.getElementById("my-matches-btn");
          const sajuButton = document.getElementById("my-saju-btn");

          if (this.userInfo && this.userInfo.user_id) {
            section.style.display = "flex";
            userInfoDiv.textContent = `${this.userInfo.name}ë‹˜ (í•™ë²ˆ: ${this.userInfo.studentId})`;

            // ë§¤ì¹­ ê²°ê³¼ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            matchesButton.onclick = () => {
              window.location.href = `/matches/${this.userInfo.user_id}`;
            };

            // ì‚¬ì£¼ ê²°ê³¼ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            sajuButton.onclick = () => {
              this.showMySajuResult();
            };
          } else {
            section.style.display = "none";
          }
        }

        showMySajuResult() {
          if (this.userInfo && this.userInfo.ai_analysis) {
            const modal = document.getElementById("my-saju-modal");
            const content = document.getElementById("my-saju-content");

            content.innerHTML = `
              <div style="background-color: #fdfaf3; border: 2px solid #bda08c; border-radius: 4px; padding: 20px; line-height: 1.8; font-size: 1.4em; color: #3a3a3a; white-space: pre-wrap;">
                ${this.userInfo.ai_analysis}
              </div>
            `;

            modal.style.display = "block";
            document.body.style.overflow = "hidden"; // ë°°ê²½ ìŠ¤í¬ë¡¤ ë°©ì§€
          } else {
            alert("ì €ì¥ëœ ì‚¬ì£¼ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
          }
        }

        clearUserInfo() {
          this.userInfo = null;
          localStorage.removeItem("userData");
          this.updateMyResultsSection();
        }
      }

      // ì‚¬ìš©ì ê´€ë¦¬ì ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
      const userManager = new UserManager();

      // ì•Œë¦¼ ê¶Œí•œ ì²´í¬ ë° í¼ í•„ë“œ ê°€ì´ë“œ í•¨ìˆ˜
      function checkNotificationAndGuide() {
        if (Notification.permission !== "granted") {
          alert(
            "ğŸ”” ë§¤ì¹­ ì•Œë¦¼ì„ ë°›ê¸° ìœ„í•´ ë¨¼ì € í‘¸ì‹œ ì•Œë¦¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”!\n\nìœ„ì˜ 'í‘¸ì‹œ ì•Œë¦¼ ì„¤ì •' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì•Œë¦¼ì„ í—ˆìš©í•œ í›„ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
          );

          // í‘¸ì‹œ ì„¤ì • ë²„íŠ¼ìœ¼ë¡œ ìŠ¤í¬ë¡¤
          const pushButton = document.getElementById("push-settings-btn");
          if (pushButton && pushButton.style.display !== "none") {
            pushButton.scrollIntoView({ behavior: "smooth", block: "center" });
            // ë²„íŠ¼ ê°•ì¡° íš¨ê³¼
            pushButton.style.animation = "pulse 1s ease-in-out 3";
            pushButton.style.transform = "scale(1.05)";
            setTimeout(() => {
              pushButton.style.animation = "";
              pushButton.style.transform = "";
            }, 3000);
          }
          return false;
        }
        return true;
      }

      // ì•Œë¦¼ ê¶Œí•œ ìƒíƒœì— ë”°ë¼ í¼ UI ì—…ë°ì´íŠ¸
      function updateFormUIBasedOnNotification() {
        const submitButton = document.querySelector(
          '#saju-form button[type="submit"]'
        );

        if (Notification.permission !== "granted") {
          if (submitButton) {
            submitButton.classList.add("disabled-notification");
            submitButton.textContent = "ğŸ”” ë¨¼ì € ì•Œë¦¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”";
          }
        } else {
          if (submitButton) {
            submitButton.classList.remove("disabled-notification");
            submitButton.textContent = "ê²°ê³¼ ë³´ê¸°";
          }
        }
      }

      // ëª¨ë“  ì…ë ¥ í•„ë“œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      document.addEventListener("DOMContentLoaded", function () {
        // í˜ì´ì§€ ë¡œë“œ ì‹œ í¼ UI ìƒíƒœ ì—…ë°ì´íŠ¸
        updateFormUIBasedOnNotification();

        const formInputs = document.querySelectorAll(
          '#saju-form input:not([type="checkbox"]), #saju-form select'
        );

        formInputs.forEach((input) => {
          input.addEventListener("focus", function () {
            if (Notification.permission !== "granted") {
              this.blur(); // í¬ì»¤ìŠ¤ ì œê±°
              checkNotificationAndGuide();
            }
          });
        });

        // ê°œì¸ì •ë³´ ë™ì˜ ì²´í¬ë°•ìŠ¤ì— ëŒ€í•œ ë³„ë„ ì²˜ë¦¬
        const privacyCheckbox = document.getElementById("privacyConsent");
        if (privacyCheckbox) {
          privacyCheckbox.addEventListener("click", function (e) {
            if (Notification.permission !== "granted") {
              e.preventDefault(); // ì²´í¬ ë°©ì§€
              checkNotificationAndGuide();
            }
          });
        }
      });

      // í‘¸ì‹œ ì„¤ì • ë²„íŠ¼ ì´ë²¤íŠ¸
      document
        .getElementById("push-settings-btn")
        .addEventListener("click", async () => {
          const button = document.getElementById("push-settings-btn");
          button.disabled = true;
          button.innerHTML = "â³ ì„¤ì • ì¤‘...";

          // iOS Safari ê°ì§€
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const isSafari = /^((?!chrome|android).)*safari/i.test(
            navigator.userAgent
          );

          try {
            const permissionGranted =
              await pushManager.requestNotificationPermission();

            if (permissionGranted) {
              const subscribed = await pushManager.subscribeToPush();
              if (subscribed) {
                alert(
                  "âœ… í‘¸ì‹œ ì•Œë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!\në§¤ì¹­ì´ ì™„ë£Œë˜ë©´ ì•Œë¦¼ì„ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.\n\nì´ì œ ì•„ë˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì—¬ ì‚¬ì£¼ ë¶„ì„ì„ ë°›ì•„ë³´ì„¸ìš”!"
                );
                // í‘¸ì‹œ ì•Œë¦¼ ì„¤ì •ì´ ì™„ë£Œë˜ë©´ ë²„íŠ¼ê³¼ ìƒíƒœ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                document.getElementById("push-settings-btn").style.display =
                  "none";
                document.getElementById("push-status").style.display = "none";

                // í¼ UI ì—…ë°ì´íŠ¸ (ë²„íŠ¼ í™œì„±í™”)
                updateFormUIBasedOnNotification();
              } else {
                alert(
                  "í‘¸ì‹œ ì•Œë¦¼ êµ¬ë…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
                );
              }
            } else {
              // requestNotificationPermission()ì—ì„œ ì´ë¯¸ alert í‘œì‹œí–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ
              console.log("í‘¸ì‹œ ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
          } catch (error) {
            console.error("í‘¸ì‹œ ì„¤ì • ì‹¤íŒ¨:", error);
            alert("í‘¸ì‹œ ì•Œë¦¼ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          } finally {
            button.disabled = false;
            button.innerHTML = "ğŸ”” í‘¸ì‹œ ì•Œë¦¼ ì„¤ì •";
          }
        });

      sajuForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        // ì•Œë¦¼ ê¶Œí•œ í™•ì¸ - ê°€ì¥ ë¨¼ì € ì²´í¬
        if (Notification.permission !== "granted") {
          alert(
            "ğŸ”” ë§¤ì¹­ ì•Œë¦¼ì„ ë°›ê¸° ìœ„í•´ ë¨¼ì € í‘¸ì‹œ ì•Œë¦¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”!\n\nìœ„ì˜ 'í‘¸ì‹œ ì•Œë¦¼ ì„¤ì •' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì•Œë¦¼ì„ í—ˆìš©í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
          );
          // í‘¸ì‹œ ì„¤ì • ë²„íŠ¼ìœ¼ë¡œ ìŠ¤í¬ë¡¤
          const pushButton = document.getElementById("push-settings-btn");
          if (pushButton && pushButton.style.display !== "none") {
            pushButton.scrollIntoView({ behavior: "smooth", block: "center" });
            // ë²„íŠ¼ ê°•ì¡° íš¨ê³¼
            pushButton.style.animation = "pulse 1s ease-in-out 3";
            pushButton.style.transform = "scale(1.05)";
            setTimeout(() => {
              pushButton.style.animation = "";
              pushButton.style.transform = "";
            }, 3000);
          }
          return;
        }

        // ì„±ë³„ ì„ íƒ í™•ì¸
        const gender = document.getElementById("gender").value;
        if (!gender) {
          alert("ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
          document.getElementById("gender").focus();
          return;
        }

        // ì¸ìŠ¤íƒ€ê·¸ë¨ ì•„ì´ë”” ìœ íš¨ì„± ê²€ì‚¬
        const instagramId = document.getElementById("instagramId").value.trim();
        if (!instagramId) {
          alert("ì¸ìŠ¤íƒ€ê·¸ë¨ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          document.getElementById("instagramId").focus();
          return;
        }

        // ì¸ìŠ¤íƒ€ê·¸ë¨ ì•„ì´ë”” í˜•ì‹ ê²€ì‚¬ (@ ì—†ì´ ì…ë ¥í•´ì•¼ í•¨)
        if (instagramId.startsWith("@")) {
          alert(
            "ì¸ìŠ¤íƒ€ê·¸ë¨ ì•„ì´ë”” ì•ì— @ë¥¼ ë¶™ì´ì§€ ë§ê³  ì…ë ¥í•´ì£¼ì„¸ìš”.\nì˜ˆ: my_instagram"
          );
          document.getElementById("instagramId").focus();
          return;
        }

        // ê°œì¸ì •ë³´ ë™ì˜ ì²´í¬ í™•ì¸
        const privacyConsent = document.getElementById("privacyConsent");
        if (!privacyConsent.checked) {
          alert("ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ì— ë™ì˜í•´ì£¼ì„¸ìš”.");
          privacyConsent.focus();
          return;
        }

        // ëª¨ë‹¬ ì—´ê¸° ë° ë¡œë”© ìƒíƒœ í‘œì‹œ
        openModal();
        showLoading();

        const birthdate = document.getElementById("birthdate").value;
        const birthDateObj = new Date(birthdate);
        const data = {
          name: document.getElementById("name").value,
          studentId: document.getElementById("studentId").value,
          year: birthDateObj.getFullYear(),
          month: birthDateObj.getMonth() + 1, // getMonth()ëŠ” 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +1
          day: birthDateObj.getDate(),
          hour: parseInt(document.getElementById("hour").value),
          mbti: document.getElementById("mbti").value.toUpperCase(),
          gender: document.getElementById("gender").value,
          instagramId: document.getElementById("instagramId").value,
        };

        try {
          const response = await fetch("/saju", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          const result = await response.json();
          if (response.ok) {
            showResult(result.ai_analysis);

            // ì‚¬ìš©ì IDê°€ ìˆìœ¼ë©´ ë””ë°”ì´ìŠ¤ ì—°ê²° ë° ì‚¬ìš©ì ì •ë³´ ì €ì¥
            if (result.user_id) {
              await pushManager.linkDeviceToUser(result.user_id);

              // ì‚¬ìš©ì ì •ë³´ë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
              const userData = {
                user_id: result.user_id,
                name: data.name,
                studentId: data.studentId,
                mbti: data.mbti,
                gender: data.gender,
                ai_analysis: result.ai_analysis,
              };
              userManager.saveUserInfo(userData);
            }
          } else {
            showResult("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + result.error);
          }
        } catch (error) {
          showResult(
            "ì„œë²„ì™€ í†µì‹ í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì¼œì ¸ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”."
          );
        }
      });

      // Service Worker ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬ (ì•Œë¦¼ í´ë¦­ ì‹œ í˜ì´ì§€ ì´ë™)
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.addEventListener("message", function (event) {
          console.log("ğŸ“¨ Service Worker ë©”ì‹œì§€ ìˆ˜ì‹ :", event.data);

          if (event.data && event.data.type === "NAVIGATE" && event.data.url) {
            console.log(
              `ğŸ”„ í˜ì´ì§€ ì´ë™ ìš”ì²­: ${window.location.href} â†’ ${event.data.url}`
            );

            try {
              // ê°•ì œ í˜ì´ì§€ ì´ë™
              console.log("ğŸš€ í˜ì´ì§€ ì´ë™ ì‹¤í–‰ ì¤‘...");
              window.location.href = event.data.url;

              // í˜¹ì‹œ ìœ„ê°€ ì•ˆ ë˜ë©´ replaceë„ ì‹œë„
              setTimeout(() => {
                console.log("ğŸ”„ window.location.replace ì‹œë„");
                window.location.replace(event.data.url);
              }, 100);
            } catch (err) {
              console.error("âŒ í˜ì´ì§€ ì´ë™ ì‹¤íŒ¨:", err);
              // ìµœí›„ì˜ ìˆ˜ë‹¨: ìƒˆ ì°½ ì—´ê¸°
              try {
                window.open(event.data.url, "_blank");
                console.log("ğŸ†• ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸° ì‹œë„");
              } catch (openErr) {
                console.error("âŒ ìƒˆ ì°½ ì—´ê¸°ë„ ì‹¤íŒ¨:", openErr);
              }
            }
          }
        });

        // ë©”ì‹œì§€ ìˆ˜ì‹  í™•ì¸ì„ ìœ„í•œ ì¶”ê°€ ì´ë²¤íŠ¸
        navigator.serviceWorker.ready.then((registration) => {
          console.log("ğŸ”§ Service Worker ì¤€ë¹„ ì™„ë£Œ, ë©”ì‹œì§€ ìˆ˜ì‹  ëŒ€ê¸° ì¤‘");
        });
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ URL íŒŒë¼ë¯¸í„° í™•ì¸ (ì•Œë¦¼ì—ì„œ í™ˆìœ¼ë¡œ ì˜¨ ê²½ìš°)
      document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const notification = urlParams.get("notification");

        if (notification === "waiting") {
          // ë§¤ì¹­ ëŒ€ê¸° ì¤‘ ì•Œë¦¼ì—ì„œ ì˜¨ ê²½ìš°
          setTimeout(() => {
            alert(
              "â³ ì•„ì§ ë§¤ì¹­ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.\në§¤ì¹­ì´ ì™„ë£Œë˜ë©´ ì•Œë¦¼ì„ ë³´ë‚´ë“œë¦´ê²Œìš”!"
            );
          }, 500);
        } else if (notification === "missing_user_id") {
          // user_idê°€ ì—†ì–´ì„œ ë§¤ì¹­ í˜ì´ì§€ë¡œ ì´ë™í•  ìˆ˜ ì—†ëŠ” ê²½ìš°
          setTimeout(() => {
            alert(
              "âš ï¸ ë§¤ì¹­ ì•Œë¦¼ì„ í´ë¦­í•˜ì…¨ì§€ë§Œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € ì‚¬ì£¼ ë¶„ì„ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”!"
            );
          }, 500);
        }
      });
    </script>
  </body>
</html>
